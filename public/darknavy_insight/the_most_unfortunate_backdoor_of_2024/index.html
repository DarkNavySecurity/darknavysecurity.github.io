<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>The Most Unfortunate Backdoor of 2024 | DARKNAVY</title>
<meta name=keywords content><meta name=description content="

Does open source guarantee that there are no backdoors?

At the 1983 Turing Award ceremony, Ken Thompson raised this question. As one of only three legends to win the Turing Award before the age of 40, he demonstrated how to hack Unix systems compiled from harmless source code by implanting backdoors in compilers, remaining a tale frequently cited by hackers to this day.
In 2024, the XZ backdoor incident resurfaced this question. Under the nose of the open-source community, attackers successfully pushed the backdoored xz-utils 5.6.1 package into official repositories of several distributions like Debian and Fedora. Fortunately, engineer Andres Freund discovered and reported the abnormal behavior of xz-utils 5.6.1 in time. Although the community effectively stopped the backdoor&rsquo;s spread, this heart-stopping crisis made every open-source user rethink the trust model in collaborative development."><meta name=author content="DARKNAVY"><link rel=canonical href=https://www.darknavy.org/darknavy_insight/the_most_unfortunate_backdoor_of_2024/><link crossorigin=anonymous href=/assets/css/stylesheet.86b34fc8709322911fa9e50a0b6fbe57a1a032cdd591c9f647724be25533842d.css integrity="sha256-hrNPyHCTIpEfqeUKC2++V6GgMs3Vkcn2R3JL4lUzhC0=" rel="preload stylesheet" as=style><link rel=icon href=https://www.darknavy.org/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.darknavy.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.darknavy.org/favicon-32x32.png><link rel=apple-touch-icon href=https://www.darknavy.org/apple-touch-icon.png><link rel=mask-icon href=https://www.darknavy.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.darknavy.org/darknavy_insight/the_most_unfortunate_backdoor_of_2024/><link rel=alternate hreflang=zh href=https://www.darknavy.org/zh/darknavy_insight/the_most_unfortunate_backdoor_of_2024/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-LR4ZN1LSPS"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LR4ZN1LSPS")}</script><meta property="og:url" content="https://www.darknavy.org/darknavy_insight/the_most_unfortunate_backdoor_of_2024/"><meta property="og:site_name" content="DARKNAVY"><meta property="og:title" content="The Most Unfortunate Backdoor of 2024"><meta property="og:description" content="
Does open source guarantee that there are no backdoors?
At the 1983 Turing Award ceremony, Ken Thompson raised this question. As one of only three legends to win the Turing Award before the age of 40, he demonstrated how to hack Unix systems compiled from harmless source code by implanting backdoors in compilers, remaining a tale frequently cited by hackers to this day.
In 2024, the XZ backdoor incident resurfaced this question. Under the nose of the open-source community, attackers successfully pushed the backdoored xz-utils 5.6.1 package into official repositories of several distributions like Debian and Fedora. Fortunately, engineer Andres Freund discovered and reported the abnormal behavior of xz-utils 5.6.1 in time. Although the community effectively stopped the backdoor’s spread, this heart-stopping crisis made every open-source user rethink the trust model in collaborative development."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="darknavy_insight"><meta property="article:published_time" content="2025-02-13T17:07:28+08:00"><meta property="article:modified_time" content="2025-02-13T17:07:28+08:00"><meta property="og:image" content="https://www.darknavy.org/darknavy_insight/the_most_unfortunate_backdoor_of_2024/attachments/f4924b5c-b046-42e2-9f80-45f00f4a132c.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.darknavy.org/darknavy_insight/the_most_unfortunate_backdoor_of_2024/attachments/f4924b5c-b046-42e2-9f80-45f00f4a132c.png"><meta name=twitter:title content="The Most Unfortunate Backdoor of 2024"><meta name=twitter:description content="

Does open source guarantee that there are no backdoors?

At the 1983 Turing Award ceremony, Ken Thompson raised this question. As one of only three legends to win the Turing Award before the age of 40, he demonstrated how to hack Unix systems compiled from harmless source code by implanting backdoors in compilers, remaining a tale frequently cited by hackers to this day.
In 2024, the XZ backdoor incident resurfaced this question. Under the nose of the open-source community, attackers successfully pushed the backdoored xz-utils 5.6.1 package into official repositories of several distributions like Debian and Fedora. Fortunately, engineer Andres Freund discovered and reported the abnormal behavior of xz-utils 5.6.1 in time. Although the community effectively stopped the backdoor&rsquo;s spread, this heart-stopping crisis made every open-source user rethink the trust model in collaborative development."><meta name=twitter:site content="@DarkNavyOrg"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"DARKNAVY INSIGHT","item":"https://www.darknavy.org/darknavy_insight/"},{"@type":"ListItem","position":2,"name":"The Most Unfortunate Backdoor of 2024","item":"https://www.darknavy.org/darknavy_insight/the_most_unfortunate_backdoor_of_2024/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"The Most Unfortunate Backdoor of 2024","name":"The Most Unfortunate Backdoor of 2024","description":"\nDoes open source guarantee that there are no backdoors?\nAt the 1983 Turing Award ceremony, Ken Thompson raised this question. As one of only three legends to win the Turing Award before the age of 40, he demonstrated how to hack Unix systems compiled from harmless source code by implanting backdoors in compilers, remaining a tale frequently cited by hackers to this day.\nIn 2024, the XZ backdoor incident resurfaced this question. Under the nose of the open-source community, attackers successfully pushed the backdoored xz-utils 5.6.1 package into official repositories of several distributions like Debian and Fedora. Fortunately, engineer Andres Freund discovered and reported the abnormal behavior of xz-utils 5.6.1 in time. Although the community effectively stopped the backdoor\u0026rsquo;s spread, this heart-stopping crisis made every open-source user rethink the trust model in collaborative development.\n","keywords":[],"articleBody":"\nDoes open source guarantee that there are no backdoors?\nAt the 1983 Turing Award ceremony, Ken Thompson raised this question. As one of only three legends to win the Turing Award before the age of 40, he demonstrated how to hack Unix systems compiled from harmless source code by implanting backdoors in compilers, remaining a tale frequently cited by hackers to this day.\nIn 2024, the XZ backdoor incident resurfaced this question. Under the nose of the open-source community, attackers successfully pushed the backdoored xz-utils 5.6.1 package into official repositories of several distributions like Debian and Fedora. Fortunately, engineer Andres Freund discovered and reported the abnormal behavior of xz-utils 5.6.1 in time. Although the community effectively stopped the backdoor’s spread, this heart-stopping crisis made every open-source user rethink the trust model in collaborative development.\nIn this report, we will analyze the XZ backdoor from a technical point of view, from how it was planted to how it was discovered.\nThe following is the sixth article of the “DARKNAVY INSIGHT | 2024 Annual Security Report”.\nXZ backdoor: The Collapse of Trust in the Open-Source World Launched in 2005 by Lasse Collin and others, the XZ project gradually became the default compression tool for many open-source projects like Linux Kernel and FreeBSD. Some critical components like openssh-server (on some distributions like Debian) rely on its liblzma library directly or indirectly. However, a document from 2013[1] already mentioned that Lasse’s “personal issues” caused slow project maintenance - making this widely used but under-maintained software an ideal target.\nAfter identifying the target, attackers started the hunt:\nOct 2021: An account named “Jia Tan” submitted patches to xz-devel mailing lists, describing himself as a “helper elf”[2]. He has also committed contributions to projects like wasmtime and cpp-docs, earning initial trust from Lasse. May 2022: The attackers, using the accounts named “Dennis Ens” and “Jigar Kumar”, repeatedly complained on the mailing list about the slow progress of the project, pressuring Lasse to delegate more tasks to the “helpful” Jia Tan. Dec 2022: Jia Tan merged several patches into the XZ, proving that the attackers had already obtained code modification privileges for the XZ repository. Jun 2023: An account named “Hans Jansen” submitted a patch that employed glibc’s indirect function (IFUNC) mechanism to select the CRC function, laying the groundwork for the subsequent backdoor. Feb 2024: Jia Tan merged a batch of binary test files containing the backdoor and released version xz-5.6.0 with a trigger script included in the Debian unstable repository. At the same time, Jia Tan emailed Fedora 40 maintainers to request an upgrade of the xz package. Mar 4, 2024: The RedHat community reported[3] a bug in liblzma, with Valgrind’s output pointing to the backdoor entry function _get_cpuid. Attackers quickly released xz-5.6.1 with two “bugfix” patches: the first being a disguised patch claiming to fix the bug, and the second a binary patch that actually fixed the bug in the backdoor. For the latter, Jia Tan claimed the modification was due to switching to new test data generated with a deterministic random seed. Mar 28, 2024: Several accounts led by Jia Tan complained on the Debian/Ubuntu bug list, pushing for the upgrade of the xz package in Debian to the backdoored xz-5.6.1. On the same day, engineer Andres Freund discovered the abnormal behavior in liblzma-5.6.1 and reported it to the Debian community. In order to implant a backdoor into a widely used open-source software like XZ without getting noticed, the attackers carefully designed and prepared the attack beyond the technical aspects:\nLong-term infiltration: Advancing the plan on a semi-annual cycle to minimize suspicion and reduce the risk of exposure. Social engineering: Leveraging Jia Tan’s identity as a trusted contributor while deploying multiple forged user accounts to psychologically manipulate and pressure the maintainers. Distributed poisoning: Fragmenting malicious code into smaller components, embedding them within routine contributions, and submitting them gradually under multiple identities. Psychological Exploitation: Targeted maintainer burnout and users’ blind trust in source-binary consistency. The attack alerted us to rethink the trust architecture beyond technical security: How can we rebuild resilient, sustainable trust models between humans, technologies, and systems?\nThe open-source community continues to function collaboratively. Yet, if these trust vulnerabilities remain unaddressed, what happens when the next Jia Tan emerges?\n“A near miss” — Bad Luck or Skill Issue? Nine months have passed since the disclosure of the XZ backdoor, there is no lack of reverse engineering of how it works on the Internet[4,5]. However, a mystery remains: after the attackers spent more than two years meticulously hiding the backdoor, why was it discovered in such a short time?\nAndres Freund mentioned on social media that he initially only noticed that a malicious attacker was brute-forcing the server’s SSH password, which resulted in abnormally high CPU usage. He conducted a performance analysis on sshd and discovered that after updating liblzma.so, the processing time per SSH connection increased from 0.3 seconds to 0.8 seconds. Recalling a Valgrind report he had seen earlier by chance, Andres delved into an in-depth analysis of the liblzma.so in xz-5.6.1 and its source build scripts, ultimately identifying the implanted backdoor.\nHowever, prior reverse engineering analyses indicate that the backdoor in XZ 5.6.1 operates by intercepting the RSA decryption function and executing commands based on fields in the SSH client’s certificate - password logins will not trigger it [4]. Why, then, did brute-force password attempts expose anomalies?\nTo reproduce Andres’ discovery process, we used perf to conduct a performance analysis on sshd. It was evident that the backdoored liblzma.so was consuming an abnormally high amount of computational resources.\nAfter further analyzing the hot instruction at liblzma.so:0x2bbb0, we discovered that it was located in an x86_64 instruction disassembler function in the backdoor. This disassembler parses x86_64 instructions, once upon a time, at a given memory address. Invoked by other higher-level functions, it helps to locate function gadgets or global structures in stripped sshd and ld based on assembly pattern matching.\nFor example, during the initialization phase, the xz backdoor needs to modify the global variable dl_audit to a forged audit_iface structure, enabling it to hijack the symbind64 function. To determine the address of dl_audit, it scans ld’s memory for the MOV reg, DWORD PTR [RIP+imm] instruction in dl_main function and parses the referenced memory offset.\nInterestingly, the analysis revealed a “flaw” in the disassembler: while some higher-level functions advance the memory address based on the parsed instruction length, the disassembler’s internal implementation simply sets the length of each parsed instruction (a field in the parse result structure) to zero. As a result, the backdoor almost always disassembles the target binary byte by byte instead of instruction-by-instruction, leading to excessive runtime overhead.\nIn addition, there are also pattern-matching functions that explicitly call the disassembler byte-by-byte.\nDynamic analysis shows that the disassembler function was invoked 9.44 million times. In each call, the instruction liblzma.so:0x2bbb0: rep stosd—used at the very beginning to initialize the parsing result structure—is executed 22 times. That single line of code is therefore executed over 200 million times, causing liblzma.so to stand out in the perf output. We deduce that the implementation flaws in the disassembler and its pattern-matching callers are the root cause of the massive resource consumption by the backdoor during runtime.\nWe boldly speculate that the attacker may have assumed that the extensive invocation of the disassembler would occur only once during ld’s execution, impacting performance only at sshd startup. However, starting from version 3.9, openssh-server by default adopts a re-exec mode, in which every child process of sshd will call execv to reinitialize the process address space [6]:\nstatic int rexec_flag = 1; ... /* This is the child processing a new connection. */ setproctitle(\"%s\", \"[accepted]\"); /* * Create a new session and process group since the 4.4BSD * setlogin() affects the entire process group. We don't * want the child to be able to affect the parent. */ ... if (rexec_flag) { ... execv(rexec_argv[0], rexec_argv); // Make sshd(8) re-execute itself on accepting a new connection. Consequently, Whenever a new ssh client tries to connect, sshd re-executes the entire initialization process of the backdoor code, consuming about 0.5 seconds of CPU time. We conducted SSH brute-force tests on sshd and confirmed that the backdoored version exhibited dramatically higher CPU usage than the clean version (9.6% vs. 0.7%).\nTherefore, when another group of attackers attempted to brute-force SSH passwords during Andres’ usage, the extra CPU consumption caught his attention immediately and eventually led to the exposure of the backdoor.\nBy now we have finally confirmed the root cause behind the rapid discovery of the XZ backdoor. As one of the most (nearly) successful open-source supply chain attacks in recent years, Jia Tan’s “failure” highlights a key takeaway for attackers: Your code must survive stress testing.\nThis time, luck was on our side. But what if the attacker had been patient enough to optimize their code further?\nDARKNAVY INSIGHT Beyond XZ, 2024 also witnessed incidents such as CrowdStrike’s global BSOD and the pager explosion in Lebanon. Unlike EternalBlue or Log4j, these threats exploit trust chains more than technical vulnerabilities. On the other hand, the exploitation of traditional binary vulnerabilities such as memory corruption has become increasingly difficult due to the widespread adoption of various hardware and software mitigations, further pushing security researchers into new domains. In this asymmetric battlefield, redefining security boundaries and building resilient trust architectures become a challenge for every security researcher.\nReferences [1] https://github.com/kobolabs/liblzma/blob/87b7682ce4b1c849504e2b3641cebaad62aaef87/doc/history.txt [2] https://www.mail-archive.com/xz-devel@tukaani.org/msg00518.html [3] https://bugzilla.redhat.com/show_bug.cgi?id=2267598 [4] https://securelist.com/xz-backdoor-story-part-1/112354/ [5] https://gist.github.com/smx-smx/a6112d54777845d389bd7126d6e9f504 [6] https://sources.debian.org/src/openssh/1%3A9.2p1-2%2Bdeb12u4/sshd.c/#L2200 ","wordCount":"1579","inLanguage":"en","image":"https://www.darknavy.org/darknavy_insight/the_most_unfortunate_backdoor_of_2024/attachments/f4924b5c-b046-42e2-9f80-45f00f4a132c.png","datePublished":"2025-02-13T17:07:28+08:00","dateModified":"2025-02-13T17:07:28+08:00","author":{"@type":"Person","name":"DARKNAVY"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.darknavy.org/darknavy_insight/the_most_unfortunate_backdoor_of_2024/"},"publisher":{"@type":"Organization","name":"DARKNAVY","logo":{"@type":"ImageObject","url":"https://www.darknavy.org/images/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://www.darknavy.org/ accesskey=h title="  (Alt + H)"><img src=https://www.darknavy.org/images/darknavy_shenlan_dot.png alt aria-label=logo height=20></a><div class=logo-switches><ul class=lang-switch><li>|</li><li><a href=https://www.darknavy.org/zh/ title=Chinese aria-label=Chinese>Zh</a></li></ul></div></div><ul id=menu><li><a href=https://www.darknavy.org/ title=Home><span>Home</span></a></li><li><a href=https://www.darknavy.org/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://www.darknavy.org/darknavy_insight/ title=Insight><span>Insight</span></a></li><li><a href=https://www.darknavy.org/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.darknavy.org/>Home</a>&nbsp;»&nbsp;<a href=https://www.darknavy.org/darknavy_insight/>DARKNAVY INSIGHT</a></div><h1 class="post-title entry-hint-parent">The Most Unfortunate Backdoor of 2024</h1><div class=post-meta><span title='2025-02-13 17:07:28 +0800 CST'>February 13, 2025</span>&nbsp;·&nbsp;1579 words&nbsp;·&nbsp;DARKNAVY&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://www.darknavy.org/zh/darknavy_insight/the_most_unfortunate_backdoor_of_2024/>Zh</a></li></ul></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#xz-backdoor-the-collapse-of-trust-in-the-open-source-world>XZ backdoor: The Collapse of Trust in the Open-Source World</a></li><li><a href=#a-near-miss--bad-luck-or-skill-issue>&ldquo;A near miss&rdquo; — Bad Luck or Skill Issue?</a></li><li><a href=#darknavy-insight>DARKNAVY INSIGHT</a></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><p><img loading=lazy src=/darknavy_insight/the_most_unfortunate_backdoor_of_2024/attachments/474a4c83-4170-4512-bc3b-a8ec5de49be4.png></p><blockquote><p>Does open source guarantee that there are no backdoors?</p></blockquote><p>At the 1983 Turing Award ceremony, Ken Thompson raised this question. As one of only three legends to win the Turing Award before the age of 40, he demonstrated how to hack Unix systems compiled from harmless source code by implanting backdoors in compilers, remaining a tale frequently cited by hackers to this day.</p><p>In 2024, the XZ backdoor incident resurfaced this question. Under the nose of the open-source community, attackers successfully pushed the backdoored xz-utils 5.6.1 package into official repositories of several distributions like Debian and Fedora. Fortunately, engineer Andres Freund discovered and reported the abnormal behavior of xz-utils 5.6.1 in time. Although the community effectively stopped the backdoor&rsquo;s spread, this heart-stopping crisis made every open-source user rethink the trust model in collaborative development.</p><p>In this report, we will analyze the XZ backdoor from a technical point of view, from how it was planted to how it was discovered.</p><p>The following is the sixth article of the &ldquo;DARKNAVY INSIGHT | 2024 Annual Security Report&rdquo;.</p><p><img loading=lazy src=/darknavy_insight/the_most_unfortunate_backdoor_of_2024/attachments/f4924b5c-b046-42e2-9f80-45f00f4a132c.png></p><hr><h2 id=xz-backdoor-the-collapse-of-trust-in-the-open-source-world>XZ backdoor: The Collapse of Trust in the Open-Source World<a hidden class=anchor aria-hidden=true href=#xz-backdoor-the-collapse-of-trust-in-the-open-source-world>#</a></h2><p>Launched in 2005 by Lasse Collin and others, the XZ project gradually became the default compression tool for many open-source projects like Linux Kernel and FreeBSD. Some critical components like <code>openssh-server</code> (on some distributions like Debian) rely on its <code>liblzma</code> library directly or indirectly. However, a document from 2013[1] already mentioned that Lasse&rsquo;s &ldquo;personal issues&rdquo; caused slow project maintenance - making this widely used but under-maintained software an ideal target.</p><p>After identifying the target, attackers started the hunt:</p><ul><li><strong>Oct 2021</strong>: An account named &ldquo;Jia Tan&rdquo; submitted patches to xz-devel mailing lists, describing himself as a &ldquo;helper elf&rdquo;[2]. He has also committed contributions to projects like <code>wasmtime</code> and <code>cpp-docs</code>, earning initial trust from Lasse.</li><li><strong>May 2022</strong>: The attackers, using the accounts named &ldquo;Dennis Ens&rdquo; and &ldquo;Jigar Kumar&rdquo;, repeatedly complained on the mailing list about the slow progress of the project, pressuring Lasse to delegate more tasks to the &ldquo;helpful&rdquo; Jia Tan.</li><li><strong>Dec 2022</strong>: Jia Tan merged several patches into the XZ, proving that <strong>the attackers had already obtained code modification privileges for the XZ repository.</strong></li><li><strong>Jun 2023</strong>: An account named &ldquo;Hans Jansen&rdquo; submitted a patch that employed glibc&rsquo;s indirect function (<code>IFUNC</code>) mechanism to select the CRC function, laying the groundwork for the subsequent backdoor.</li><li><strong>Feb 2024</strong>: Jia Tan merged a batch of binary test files containing the backdoor and released version xz-5.6.0 with a trigger script <strong>included in the Debian unstable repository</strong>. At the same time, Jia Tan emailed Fedora 40 maintainers to request an upgrade of the xz package.</li><li><strong>Mar 4, 2024</strong>: The RedHat community reported[3] a bug in <code>liblzma</code>, with Valgrind&rsquo;s output pointing to the backdoor entry function <code>_get_cpuid</code>. Attackers quickly released <code>xz-5.6.1</code> with two &ldquo;bugfix&rdquo; patches: the first being a disguised patch claiming to fix the bug, and the second a binary patch that actually fixed the bug in the backdoor. For the latter, Jia Tan claimed the modification was due to switching to new test data generated with a deterministic random seed.</li><li><strong>Mar 28, 2024</strong>: Several accounts led by Jia Tan complained on the Debian/Ubuntu bug list, pushing for the upgrade of the xz package in Debian to the backdoored <code>xz-5.6.1</code>. On the same day, engineer Andres Freund discovered the abnormal behavior in <code>liblzma-5.6.1</code> and reported it to the Debian community.</li></ul><p>In order to implant a backdoor into a widely used open-source software like XZ without getting noticed, the attackers carefully designed and prepared the attack beyond the technical aspects:</p><ol><li><strong>Long-term infiltration:</strong> Advancing the plan on a semi-annual cycle to minimize suspicion and reduce the risk of exposure.</li><li><strong>Social engineering:</strong> Leveraging Jia Tan&rsquo;s identity as a trusted contributor while deploying multiple forged user accounts to psychologically manipulate and pressure the maintainers.</li><li><strong>Distributed poisoning:</strong> Fragmenting malicious code into smaller components, embedding them within routine contributions, and submitting them gradually under multiple identities.</li><li><strong>Psychological Exploitation</strong>: Targeted maintainer burnout and users&rsquo; blind trust in source-binary consistency.</li></ol><p>The attack alerted us to rethink the trust architecture beyond technical security: How can we rebuild resilient, sustainable trust models between humans, technologies, and systems?</p><blockquote><p>The open-source community continues to function collaboratively. Yet, if these trust vulnerabilities remain unaddressed, what happens when the next Jia Tan emerges?</p></blockquote><h2 id=a-near-miss--bad-luck-or-skill-issue>&ldquo;A near miss&rdquo; — Bad Luck or Skill Issue?<a hidden class=anchor aria-hidden=true href=#a-near-miss--bad-luck-or-skill-issue>#</a></h2><p>Nine months have passed since the disclosure of the XZ backdoor, there is no lack of reverse engineering of how it works on the Internet[4,5]. However, a mystery remains: after the attackers spent more than two years meticulously hiding the backdoor, why was it discovered in such a short time?</p><p>Andres Freund mentioned on social media that he initially only noticed that a malicious attacker was <strong>brute-forcing the server&rsquo;s SSH password</strong>, which resulted in abnormally high CPU usage. He conducted a performance analysis on <code>sshd</code> and discovered that after updating <code>liblzma.so</code>, the processing time per SSH connection increased from 0.3 seconds to 0.8 seconds. Recalling a Valgrind report he had seen earlier by chance, Andres delved into an in-depth analysis of the <code>liblzma.so</code> in <code>xz-5.6.1</code> and its source build scripts, ultimately identifying the implanted backdoor.</p><img src=attachments/df04508b-20dc-4c86-98e6-4cdd200ba398.png style=display:block;margin-left:auto;margin-right:auto;zoom:100%><p>However, prior reverse engineering analyses indicate that the backdoor in XZ 5.6.1 operates by intercepting the RSA decryption function and executing commands based on fields in the SSH client&rsquo;s certificate - <strong>password logins will not trigger it</strong> [4]. Why, then, did brute-force password attempts expose anomalies?</p><p>To reproduce Andres&rsquo; discovery process, we used <code>perf</code> to conduct a performance analysis on <code>sshd</code>. It was evident that the backdoored <code>liblzma.so</code> was consuming an abnormally high amount of computational resources.</p><p><img alt=使用有(左)/无(右)后门的liblzma.so的sshd进程在处理ssh密码登录时的性能分析结果 loading=lazy src=/darknavy_insight/the_most_unfortunate_backdoor_of_2024/attachments/db017511-7ddd-4b7d-a5c4-72bc61eb6de9.png></p><p>After further analyzing the hot instruction at <code>liblzma.so:0x2bbb0</code>, we discovered that it was located in an <strong>x86_64 instruction disassembler</strong> function in the backdoor. This disassembler parses x86_64 instructions, once upon a time, at a given memory address. Invoked by other higher-level functions, it helps to locate function gadgets or global structures in stripped <code>sshd</code> and <code>ld</code> based on assembly pattern matching.</p><p>For example, during the initialization phase, the xz backdoor needs to modify the global variable <code>dl_audit</code> to a forged <code>audit_iface</code> structure, enabling it to hijack the <code>symbind64</code> function. To determine the address of <code>dl_audit</code>, it scans <code>ld</code>&rsquo;s memory for the <code>MOV reg, DWORD PTR [RIP+imm]</code> instruction in <code>dl_main</code> function and parses the referenced memory offset.</p><p><img alt=后门通过解析指令获取dl_audit全局变量地址 loading=lazy src=/darknavy_insight/the_most_unfortunate_backdoor_of_2024/attachments/99373794-f200-4be2-8b90-ebd2055c6a67.png></p><p>Interestingly, the analysis revealed a &ldquo;flaw&rdquo; in the disassembler: while some higher-level functions advance the memory address based on the parsed instruction length, the disassembler&rsquo;s internal implementation simply sets the length of each parsed instruction (a field in the parse result structure) to <strong>zero</strong>. As a result, the backdoor almost always disassembles the target binary <strong>byte by byte</strong> instead of instruction-by-instruction, leading to excessive runtime overhead.</p><p><img loading=lazy src=/darknavy_insight/the_most_unfortunate_backdoor_of_2024/attachments/6c2fa2ca-e2eb-4eaa-8002-4e2a2e261a26.png></p><p>In addition, there are also pattern-matching functions that explicitly call the disassembler byte-by-byte.</p><img src=attachments/12417290-5f19-431b-ac35-1bcb9a60027e.png style=display:block;margin-left:auto;margin-right:auto;zoom:100%><p>Dynamic analysis shows that the disassembler function was invoked <strong>9.44 million times</strong>. In each call, the instruction <code>liblzma.so:0x2bbb0: rep stosd</code>—used at the very beginning to initialize the parsing result structure—is executed 22 times. That single line of code is therefore executed over <strong>200 million times</strong>, causing <code>liblzma.so</code> to stand out in the <code>perf</code> output. We deduce that the implementation flaws in the disassembler and its pattern-matching callers are the root cause of the massive resource consumption by the backdoor during runtime.</p><p>We boldly speculate that the attacker may have assumed that the extensive invocation of the disassembler would occur only once during <code>ld</code>&rsquo;s execution, impacting performance only at <code>sshd</code> startup. However, starting from version 3.9, openssh-server by default adopts a <code>re-exec</code> mode, in which every child process of <code>sshd</code> will call <code>execv</code> to reinitialize the process address space [6]:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>rexec_flag</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=cm>/* This is the child processing a new connection. */</span>
</span></span><span class=line><span class=cl><span class=nf>setproctitle</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=s>&#34;[accepted]&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Create a new session and process group since the 4.4BSD
</span></span></span><span class=line><span class=cl><span class=cm> * setlogin() affects the entire process group.  We don&#39;t
</span></span></span><span class=line><span class=cl><span class=cm> * want the child to be able to affect the parent.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>rexec_flag</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nf>execv</span><span class=p>(</span><span class=n>rexec_argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>rexec_argv</span><span class=p>);</span> <span class=c1>// Make sshd(8) re-execute itself on accepting a new connection.
</span></span></span></code></pre></div><p>Consequently, Whenever a new ssh client tries to connect, <code>sshd</code> re-executes the entire initialization process of the backdoor code, consuming about 0.5 seconds of CPU time. We conducted SSH brute-force tests on <code>sshd</code> and confirmed that the backdoored version exhibited dramatically higher CPU usage than the clean version (<strong>9.6% vs. 0.7%</strong>).</p><p><img loading=lazy src=/darknavy_insight/the_most_unfortunate_backdoor_of_2024/attachments/47cad1d7-c0d6-4368-b2f7-75bdc269040f.png></p><p>Therefore, when another group of attackers attempted to brute-force SSH passwords during Andres&rsquo; usage, the extra CPU consumption caught his attention immediately and eventually led to the exposure of the backdoor.</p><img src=attachments/132eb9de-c98b-4d35-8e1b-70f019b9e748.png style=display:block;margin-left:auto;margin-right:auto;zoom:80%><p>By now we have finally confirmed the root cause behind the rapid discovery of the XZ backdoor. As one of the most (nearly) successful open-source supply chain attacks in recent years, Jia Tan&rsquo;s &ldquo;failure&rdquo; highlights a key takeaway for attackers: Your code must survive stress testing.</p><blockquote><p>This time, luck was on our side. But what if the attacker had been patient enough to optimize their code further?</p></blockquote><hr><h2 id=darknavy-insight>DARKNAVY INSIGHT<a hidden class=anchor aria-hidden=true href=#darknavy-insight>#</a></h2><p>Beyond XZ, 2024 also witnessed incidents such as CrowdStrike&rsquo;s global BSOD and the pager explosion in Lebanon. Unlike EternalBlue or Log4j, these threats exploit trust chains more than technical vulnerabilities. On the other hand, the exploitation of traditional binary vulnerabilities such as memory corruption has become increasingly difficult due to the widespread adoption of various hardware and software mitigations, further pushing security researchers into new domains. In this asymmetric battlefield, redefining security boundaries and building resilient trust architectures become a challenge for every security researcher.</p><hr><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li>[1] <a href=https://github.com/kobolabs/liblzma/blob/87b7682ce4b1c849504e2b3641cebaad62aaef87/doc/history.txt>https://github.com/kobolabs/liblzma/blob/87b7682ce4b1c849504e2b3641cebaad62aaef87/doc/history.txt</a></li><li>[2] <a href=https://www.mail-archive.com/xz-devel@tukaani.org/msg00518.html>https://www.mail-archive.com/xz-devel@tukaani.org/msg00518.html</a></li><li>[3] <a href="https://bugzilla.redhat.com/show_bug.cgi?id=2267598">https://bugzilla.redhat.com/show_bug.cgi?id=2267598</a></li><li>[4] <a href=https://securelist.com/xz-backdoor-story-part-1/112354/>https://securelist.com/xz-backdoor-story-part-1/112354/</a></li><li>[5] <a href=https://gist.github.com/smx-smx/a6112d54777845d389bd7126d6e9f504>https://gist.github.com/smx-smx/a6112d54777845d389bd7126d6e9f504</a></li><li>[6] <a href=https://sources.debian.org/src/openssh/1%3A9.2p1-2%2Bdeb12u4/sshd.c/#L2200>https://sources.debian.org/src/openssh/1%3A9.2p1-2%2Bdeb12u4/sshd.c/#L2200</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.darknavy.org/>DARKNAVY</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>