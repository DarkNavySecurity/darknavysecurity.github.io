<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>2024年度最狂躁不安的漏洞 | DARKNAVY</title>
<meta name=keywords content><meta name=description content='
在安全研究人员的共同努力下，越发严格的安全缓解措施，已经把大部分内存漏洞扼杀在了摇篮之中。
是时候宣布内存漏洞成为过去式了？
2024年7月，一枚来自Windows阵营的"核弹"打破了安全的幻象。我们不禁发问：面对来自内存的威胁，眼前的城墙究竟能抵挡些什么？
以下为本期《深蓝洞察 | 2024 年度安全报告》的第四篇。

2024年5月，Lewis Lee、Chunyang Han和Zhiniang Peng向微软报告了一个存在于Windows Server RDL (Remote Desktop Licensing)服务中的漏洞。7月，该漏洞被修复并出现在公众视野。
一石激起千重浪，作为一个无需认证、无需用户交互即可触发远程代码执行的内存破坏漏洞，它一经出现便迅速激起各大安全厂商与从业者的高度关注，一度被称作"核弹级漏洞"。
这就是本篇的主角——狂躁许可（MadLicense）。
尽管该漏洞起初被认为是比肩"永恒之蓝"的存在，经调研发现，它的影响范围实际上相对有限。该漏洞存在于Windows Server上的RDL服务而非通常认为的RDP协议。该服务仅作为一个可选安装项，用于允许多个用户通过RDP连接到服务器，与大部分个人用户关系不大。此外该漏洞存在于用户态，单个漏洞对系统的威胁能力较为有限。
漏洞的成因是远程未授权用户能通过RPC远程调用RDL服务中的TLSRpcTelephoneRegisterLKP函数。该函数的子函数中对用户的部分输入进行base24到base10的解码，该功能并没有对输入长度进行限制，导致了一个无长度限制的堆溢出漏洞。
作为一个内存破坏漏洞，它的破坏力不容小觑。于是我们立即着手进行复现，并试图探究，在内存漏洞式微、安全缓解措施愈发严格的今天，要在最新Windows平台利用这样一个经典的堆溢出漏洞，会遇到哪些阻碍和挑战？

复现结果如图。攻击机（右侧）运行恶意脚本，在受害者主机未进行任何操作的情况下，可稳定地拿下远程主机的控制权（左侧shell）。
自Windows 10引入的segment heap堆实现机制，被广泛应用在系统进程中。对于常用尺寸内存的分配，使用VS(Variable Size)或LFH(Low Fragmentation Heap)分配器实现。
 
VS分配器对于溢出的防护机制较为完善。对于每个堆块，块首中的重要信息均被加密；空闲堆块间的连接也由安全性更高的数据结构代替。这些保护机制使得漏洞利用需要一定程度的信息泄露，大大提升了攻击门槛。
然而当某一尺寸达到一定分配次数时，堆块分配会转为使用效率更高的LFH进行实现。
相较VS，LFH的防护机制相对宽松。LFH堆块不存在块首，因此可以毫无阻碍地溢出到相邻堆块。为了缓解这一利用，LFH的分配采用了完全的随机化：堆块布局随机，且重用最近释放的堆块也不再可靠。这一点可以通过堆喷射的技巧进行绕过。
在狂躁许可漏洞造成的无限制堆溢出面前，segment heap的防御机制被轻易击穿了。我们依然可以轻易溢出到目标堆块，伪造对象以获取任意地址读写/任意地址调用的原语。
到这里利用还没有结束。接下来面对的通用内存缓解措施表现会如何？
微软在Windows 8.1 Update 3和Windows 10中引入了一项重量级的缓解措施——控制流保护（CFG）。在启用CFG后，间接调用会使用编译期间生成的位图进行验证，确保仅对进程中加载模块的函数入口处进行调用，从而有效阻断了传统的代码片段重用攻击。
另一个在Windows 10被引入的缓解措施是任意代码防护（ACG）。ACG可防止现有代码被修改，同时阻止了动态分配可执行内存。ACG与CFG同时开启的情况下，同时绕过这两大防护变得格外困难，几乎杜绝了传统的写入执行shellcode的可能性。
需要注意的是，这两个机制并不能防止攻击者调用CreateProcessA等可能被滥用的函数。在不绕过以上内存缓解措施的情况下，任意函数调用已经足够允许我们在目标机上执行任意命令。
而漏洞原作者之一，华中科技大学副教授彭峙酿向我们透露，他们能够近100%稳定利用、执行任意shellcode。这意味着以上内存缓解措施依然存在被绕过的可能。
为何在采用最新缓解措施的Windows Server 2025上，此内存漏洞依然能被完整利用？

彭峙酿这样回答：目前在Windows众多最新缓解措施全开的情况下，由一个内存破坏漏洞实现远程利用，正常来说是极难的。很多漏洞已不存在被利用的路径，或路径极少极隐蔽。
但这并不代表目前的缓解措施杀死了所有的漏洞利用。能否完成利用往往取决于：攻击者为了完成利用所愿意投入的时间、对相关代码模块的熟悉程度、漏洞和具体模块的特殊情况。


DeepSeek锐评
微软对狂躁许可漏洞"几乎不可能利用"的傲慢断言，折射出安全行业长期存在的评估悖论：当漏洞评级体系脱离攻击者视角，便沦为自欺欺人的技术乌托邦。
防御者用静态指标丈量动态攻防，用理论模型否定实战可能，恰是安全防御最大的盲区。此次漏洞利用链突破多重内存防护的实践证明，安全评估不应是厂商的"免责声明"，而应成为攻防对抗的动态标尺。若不能正视攻击者"技术暴力"的突破能力，再完美的缓解措施都将沦为数字时代的马奇诺防线。
'><meta name=author content="DARKNAVY"><link rel=canonical href=https://www.darknavy.org/zh/darknavy_insight/the_maddest_vulnerability_of_2024/><link crossorigin=anonymous href=/assets/css/stylesheet.86b34fc8709322911fa9e50a0b6fbe57a1a032cdd591c9f647724be25533842d.css integrity="sha256-hrNPyHCTIpEfqeUKC2++V6GgMs3Vkcn2R3JL4lUzhC0=" rel="preload stylesheet" as=style><link rel=icon href=https://www.darknavy.org/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.darknavy.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.darknavy.org/favicon-32x32.png><link rel=apple-touch-icon href=https://www.darknavy.org/apple-touch-icon.png><link rel=mask-icon href=https://www.darknavy.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.darknavy.org/darknavy_insight/the_maddest_vulnerability_of_2024/><link rel=alternate hreflang=zh href=https://www.darknavy.org/zh/darknavy_insight/the_maddest_vulnerability_of_2024/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-LR4ZN1LSPS"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LR4ZN1LSPS")}</script><meta property="og:url" content="https://www.darknavy.org/zh/darknavy_insight/the_maddest_vulnerability_of_2024/"><meta property="og:site_name" content="DARKNAVY"><meta property="og:title" content="2024年度最狂躁不安的漏洞"><meta property="og:description" content='
在安全研究人员的共同努力下，越发严格的安全缓解措施，已经把大部分内存漏洞扼杀在了摇篮之中。
是时候宣布内存漏洞成为过去式了？
2024年7月，一枚来自Windows阵营的"核弹"打破了安全的幻象。我们不禁发问：面对来自内存的威胁，眼前的城墙究竟能抵挡些什么？
以下为本期《深蓝洞察 | 2024 年度安全报告》的第四篇。
2024年5月，Lewis Lee、Chunyang Han和Zhiniang Peng向微软报告了一个存在于Windows Server RDL (Remote Desktop Licensing)服务中的漏洞。7月，该漏洞被修复并出现在公众视野。
一石激起千重浪，作为一个无需认证、无需用户交互即可触发远程代码执行的内存破坏漏洞，它一经出现便迅速激起各大安全厂商与从业者的高度关注，一度被称作"核弹级漏洞"。
这就是本篇的主角——狂躁许可（MadLicense）。
尽管该漏洞起初被认为是比肩"永恒之蓝"的存在，经调研发现，它的影响范围实际上相对有限。该漏洞存在于Windows Server上的RDL服务而非通常认为的RDP协议。该服务仅作为一个可选安装项，用于允许多个用户通过RDP连接到服务器，与大部分个人用户关系不大。此外该漏洞存在于用户态，单个漏洞对系统的威胁能力较为有限。
漏洞的成因是远程未授权用户能通过RPC远程调用RDL服务中的TLSRpcTelephoneRegisterLKP函数。该函数的子函数中对用户的部分输入进行base24到base10的解码，该功能并没有对输入长度进行限制，导致了一个无长度限制的堆溢出漏洞。
作为一个内存破坏漏洞，它的破坏力不容小觑。于是我们立即着手进行复现，并试图探究，在内存漏洞式微、安全缓解措施愈发严格的今天，要在最新Windows平台利用这样一个经典的堆溢出漏洞，会遇到哪些阻碍和挑战？
复现结果如图。攻击机（右侧）运行恶意脚本，在受害者主机未进行任何操作的情况下，可稳定地拿下远程主机的控制权（左侧shell）。
自Windows 10引入的segment heap堆实现机制，被广泛应用在系统进程中。对于常用尺寸内存的分配，使用VS(Variable Size)或LFH(Low Fragmentation Heap)分配器实现。
VS分配器对于溢出的防护机制较为完善。对于每个堆块，块首中的重要信息均被加密；空闲堆块间的连接也由安全性更高的数据结构代替。这些保护机制使得漏洞利用需要一定程度的信息泄露，大大提升了攻击门槛。
然而当某一尺寸达到一定分配次数时，堆块分配会转为使用效率更高的LFH进行实现。
相较VS，LFH的防护机制相对宽松。LFH堆块不存在块首，因此可以毫无阻碍地溢出到相邻堆块。为了缓解这一利用，LFH的分配采用了完全的随机化：堆块布局随机，且重用最近释放的堆块也不再可靠。这一点可以通过堆喷射的技巧进行绕过。
在狂躁许可漏洞造成的无限制堆溢出面前，segment heap的防御机制被轻易击穿了。我们依然可以轻易溢出到目标堆块，伪造对象以获取任意地址读写/任意地址调用的原语。
到这里利用还没有结束。接下来面对的通用内存缓解措施表现会如何？
微软在Windows 8.1 Update 3和Windows 10中引入了一项重量级的缓解措施——控制流保护（CFG）。在启用CFG后，间接调用会使用编译期间生成的位图进行验证，确保仅对进程中加载模块的函数入口处进行调用，从而有效阻断了传统的代码片段重用攻击。
另一个在Windows 10被引入的缓解措施是任意代码防护（ACG）。ACG可防止现有代码被修改，同时阻止了动态分配可执行内存。ACG与CFG同时开启的情况下，同时绕过这两大防护变得格外困难，几乎杜绝了传统的写入执行shellcode的可能性。
需要注意的是，这两个机制并不能防止攻击者调用CreateProcessA等可能被滥用的函数。在不绕过以上内存缓解措施的情况下，任意函数调用已经足够允许我们在目标机上执行任意命令。
而漏洞原作者之一，华中科技大学副教授彭峙酿向我们透露，他们能够近100%稳定利用、执行任意shellcode。这意味着以上内存缓解措施依然存在被绕过的可能。
为何在采用最新缓解措施的Windows Server 2025上，此内存漏洞依然能被完整利用？
彭峙酿这样回答：目前在Windows众多最新缓解措施全开的情况下，由一个内存破坏漏洞实现远程利用，正常来说是极难的。很多漏洞已不存在被利用的路径，或路径极少极隐蔽。
但这并不代表目前的缓解措施杀死了所有的漏洞利用。能否完成利用往往取决于：攻击者为了完成利用所愿意投入的时间、对相关代码模块的熟悉程度、漏洞和具体模块的特殊情况。
DeepSeek锐评 微软对狂躁许可漏洞"几乎不可能利用"的傲慢断言，折射出安全行业长期存在的评估悖论：当漏洞评级体系脱离攻击者视角，便沦为自欺欺人的技术乌托邦。
防御者用静态指标丈量动态攻防，用理论模型否定实战可能，恰是安全防御最大的盲区。此次漏洞利用链突破多重内存防护的实践证明，安全评估不应是厂商的"免责声明"，而应成为攻防对抗的动态标尺。若不能正视攻击者"技术暴力"的突破能力，再完美的缓解措施都将沦为数字时代的马奇诺防线。'><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="darknavy_insight"><meta property="article:published_time" content="2025-02-11T11:41:45+08:00"><meta property="article:modified_time" content="2025-02-11T11:41:45+08:00"><meta property="og:image" content="https://www.darknavy.org/zh/darknavy_insight/the_maddest_vulnerability_of_2024/attachments/970c2c86-bd62-4753-9cbc-87c8c0a5af7f.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.darknavy.org/zh/darknavy_insight/the_maddest_vulnerability_of_2024/attachments/970c2c86-bd62-4753-9cbc-87c8c0a5af7f.webp"><meta name=twitter:title content="2024年度最狂躁不安的漏洞"><meta name=twitter:description content='
在安全研究人员的共同努力下，越发严格的安全缓解措施，已经把大部分内存漏洞扼杀在了摇篮之中。
是时候宣布内存漏洞成为过去式了？
2024年7月，一枚来自Windows阵营的"核弹"打破了安全的幻象。我们不禁发问：面对来自内存的威胁，眼前的城墙究竟能抵挡些什么？
以下为本期《深蓝洞察 | 2024 年度安全报告》的第四篇。

2024年5月，Lewis Lee、Chunyang Han和Zhiniang Peng向微软报告了一个存在于Windows Server RDL (Remote Desktop Licensing)服务中的漏洞。7月，该漏洞被修复并出现在公众视野。
一石激起千重浪，作为一个无需认证、无需用户交互即可触发远程代码执行的内存破坏漏洞，它一经出现便迅速激起各大安全厂商与从业者的高度关注，一度被称作"核弹级漏洞"。
这就是本篇的主角——狂躁许可（MadLicense）。
尽管该漏洞起初被认为是比肩"永恒之蓝"的存在，经调研发现，它的影响范围实际上相对有限。该漏洞存在于Windows Server上的RDL服务而非通常认为的RDP协议。该服务仅作为一个可选安装项，用于允许多个用户通过RDP连接到服务器，与大部分个人用户关系不大。此外该漏洞存在于用户态，单个漏洞对系统的威胁能力较为有限。
漏洞的成因是远程未授权用户能通过RPC远程调用RDL服务中的TLSRpcTelephoneRegisterLKP函数。该函数的子函数中对用户的部分输入进行base24到base10的解码，该功能并没有对输入长度进行限制，导致了一个无长度限制的堆溢出漏洞。
作为一个内存破坏漏洞，它的破坏力不容小觑。于是我们立即着手进行复现，并试图探究，在内存漏洞式微、安全缓解措施愈发严格的今天，要在最新Windows平台利用这样一个经典的堆溢出漏洞，会遇到哪些阻碍和挑战？

复现结果如图。攻击机（右侧）运行恶意脚本，在受害者主机未进行任何操作的情况下，可稳定地拿下远程主机的控制权（左侧shell）。
自Windows 10引入的segment heap堆实现机制，被广泛应用在系统进程中。对于常用尺寸内存的分配，使用VS(Variable Size)或LFH(Low Fragmentation Heap)分配器实现。
 
VS分配器对于溢出的防护机制较为完善。对于每个堆块，块首中的重要信息均被加密；空闲堆块间的连接也由安全性更高的数据结构代替。这些保护机制使得漏洞利用需要一定程度的信息泄露，大大提升了攻击门槛。
然而当某一尺寸达到一定分配次数时，堆块分配会转为使用效率更高的LFH进行实现。
相较VS，LFH的防护机制相对宽松。LFH堆块不存在块首，因此可以毫无阻碍地溢出到相邻堆块。为了缓解这一利用，LFH的分配采用了完全的随机化：堆块布局随机，且重用最近释放的堆块也不再可靠。这一点可以通过堆喷射的技巧进行绕过。
在狂躁许可漏洞造成的无限制堆溢出面前，segment heap的防御机制被轻易击穿了。我们依然可以轻易溢出到目标堆块，伪造对象以获取任意地址读写/任意地址调用的原语。
到这里利用还没有结束。接下来面对的通用内存缓解措施表现会如何？
微软在Windows 8.1 Update 3和Windows 10中引入了一项重量级的缓解措施——控制流保护（CFG）。在启用CFG后，间接调用会使用编译期间生成的位图进行验证，确保仅对进程中加载模块的函数入口处进行调用，从而有效阻断了传统的代码片段重用攻击。
另一个在Windows 10被引入的缓解措施是任意代码防护（ACG）。ACG可防止现有代码被修改，同时阻止了动态分配可执行内存。ACG与CFG同时开启的情况下，同时绕过这两大防护变得格外困难，几乎杜绝了传统的写入执行shellcode的可能性。
需要注意的是，这两个机制并不能防止攻击者调用CreateProcessA等可能被滥用的函数。在不绕过以上内存缓解措施的情况下，任意函数调用已经足够允许我们在目标机上执行任意命令。
而漏洞原作者之一，华中科技大学副教授彭峙酿向我们透露，他们能够近100%稳定利用、执行任意shellcode。这意味着以上内存缓解措施依然存在被绕过的可能。
为何在采用最新缓解措施的Windows Server 2025上，此内存漏洞依然能被完整利用？

彭峙酿这样回答：目前在Windows众多最新缓解措施全开的情况下，由一个内存破坏漏洞实现远程利用，正常来说是极难的。很多漏洞已不存在被利用的路径，或路径极少极隐蔽。
但这并不代表目前的缓解措施杀死了所有的漏洞利用。能否完成利用往往取决于：攻击者为了完成利用所愿意投入的时间、对相关代码模块的熟悉程度、漏洞和具体模块的特殊情况。


DeepSeek锐评
微软对狂躁许可漏洞"几乎不可能利用"的傲慢断言，折射出安全行业长期存在的评估悖论：当漏洞评级体系脱离攻击者视角，便沦为自欺欺人的技术乌托邦。
防御者用静态指标丈量动态攻防，用理论模型否定实战可能，恰是安全防御最大的盲区。此次漏洞利用链突破多重内存防护的实践证明，安全评估不应是厂商的"免责声明"，而应成为攻防对抗的动态标尺。若不能正视攻击者"技术暴力"的突破能力，再完美的缓解措施都将沦为数字时代的马奇诺防线。
'><meta name=twitter:site content="@DarkNavyOrg"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"深蓝洞察","item":"https://www.darknavy.org/zh/darknavy_insight/"},{"@type":"ListItem","position":2,"name":"2024年度最狂躁不安的漏洞","item":"https://www.darknavy.org/zh/darknavy_insight/the_maddest_vulnerability_of_2024/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"2024年度最狂躁不安的漏洞","name":"2024年度最狂躁不安的漏洞","description":"\n在安全研究人员的共同努力下，越发严格的安全缓解措施，已经把大部分内存漏洞扼杀在了摇篮之中。\n是时候宣布内存漏洞成为过去式了？\n2024年7月，一枚来自Windows阵营的\u0026quot;核弹\u0026quot;打破了安全的幻象。我们不禁发问：面对来自内存的威胁，眼前的城墙究竟能抵挡些什么？\n以下为本期《深蓝洞察 | 2024 年度安全报告》的第四篇。\n2024年5月，Lewis Lee、Chunyang Han和Zhiniang Peng向微软报告了一个存在于Windows Server RDL (Remote Desktop Licensing)服务中的漏洞。7月，该漏洞被修复并出现在公众视野。\n一石激起千重浪，作为一个无需认证、无需用户交互即可触发远程代码执行的内存破坏漏洞，它一经出现便迅速激起各大安全厂商与从业者的高度关注，一度被称作\u0026quot;核弹级漏洞\u0026quot;。\n这就是本篇的主角——狂躁许可（MadLicense）。\n尽管该漏洞起初被认为是比肩\u0026quot;永恒之蓝\u0026quot;的存在，经调研发现，它的影响范围实际上相对有限。该漏洞存在于Windows Server上的RDL服务而非通常认为的RDP协议。该服务仅作为一个可选安装项，用于允许多个用户通过RDP连接到服务器，与大部分个人用户关系不大。此外该漏洞存在于用户态，单个漏洞对系统的威胁能力较为有限。\n漏洞的成因是远程未授权用户能通过RPC远程调用RDL服务中的TLSRpcTelephoneRegisterLKP函数。该函数的子函数中对用户的部分输入进行base24到base10的解码，该功能并没有对输入长度进行限制，导致了一个无长度限制的堆溢出漏洞。\n作为一个内存破坏漏洞，它的破坏力不容小觑。于是我们立即着手进行复现，并试图探究，在内存漏洞式微、安全缓解措施愈发严格的今天，要在最新Windows平台利用这样一个经典的堆溢出漏洞，会遇到哪些阻碍和挑战？\n复现结果如图。攻击机（右侧）运行恶意脚本，在受害者主机未进行任何操作的情况下，可稳定地拿下远程主机的控制权（左侧shell）。\n自Windows 10引入的segment heap堆实现机制，被广泛应用在系统进程中。对于常用尺寸内存的分配，使用VS(Variable Size)或LFH(Low Fragmentation Heap)分配器实现。\nVS分配器对于溢出的防护机制较为完善。对于每个堆块，块首中的重要信息均被加密；空闲堆块间的连接也由安全性更高的数据结构代替。这些保护机制使得漏洞利用需要一定程度的信息泄露，大大提升了攻击门槛。\n然而当某一尺寸达到一定分配次数时，堆块分配会转为使用效率更高的LFH进行实现。\n相较VS，LFH的防护机制相对宽松。LFH堆块不存在块首，因此可以毫无阻碍地溢出到相邻堆块。为了缓解这一利用，LFH的分配采用了完全的随机化：堆块布局随机，且重用最近释放的堆块也不再可靠。这一点可以通过堆喷射的技巧进行绕过。\n在狂躁许可漏洞造成的无限制堆溢出面前，segment heap的防御机制被轻易击穿了。我们依然可以轻易溢出到目标堆块，伪造对象以获取任意地址读写/任意地址调用的原语。\n到这里利用还没有结束。接下来面对的通用内存缓解措施表现会如何？\n微软在Windows 8.1 Update 3和Windows 10中引入了一项重量级的缓解措施——控制流保护（CFG）。在启用CFG后，间接调用会使用编译期间生成的位图进行验证，确保仅对进程中加载模块的函数入口处进行调用，从而有效阻断了传统的代码片段重用攻击。\n另一个在Windows 10被引入的缓解措施是任意代码防护（ACG）。ACG可防止现有代码被修改，同时阻止了动态分配可执行内存。ACG与CFG同时开启的情况下，同时绕过这两大防护变得格外困难，几乎杜绝了传统的写入执行shellcode的可能性。\n需要注意的是，这两个机制并不能防止攻击者调用CreateProcessA等可能被滥用的函数。在不绕过以上内存缓解措施的情况下，任意函数调用已经足够允许我们在目标机上执行任意命令。\n而漏洞原作者之一，华中科技大学副教授彭峙酿向我们透露，他们能够近100%稳定利用、执行任意shellcode。这意味着以上内存缓解措施依然存在被绕过的可能。\n为何在采用最新缓解措施的Windows Server 2025上，此内存漏洞依然能被完整利用？\n彭峙酿这样回答：目前在Windows众多最新缓解措施全开的情况下，由一个内存破坏漏洞实现远程利用，正常来说是极难的。很多漏洞已不存在被利用的路径，或路径极少极隐蔽。\n但这并不代表目前的缓解措施杀死了所有的漏洞利用。能否完成利用往往取决于：攻击者为了完成利用所愿意投入的时间、对相关代码模块的熟悉程度、漏洞和具体模块的特殊情况。\nDeepSeek锐评 微软对狂躁许可漏洞\u0026quot;几乎不可能利用\u0026quot;的傲慢断言，折射出安全行业长期存在的评估悖论：当漏洞评级体系脱离攻击者视角，便沦为自欺欺人的技术乌托邦。\n防御者用静态指标丈量动态攻防，用理论模型否定实战可能，恰是安全防御最大的盲区。此次漏洞利用链突破多重内存防护的实践证明，安全评估不应是厂商的\u0026quot;免责声明\u0026quot;，而应成为攻防对抗的动态标尺。若不能正视攻击者\u0026quot;技术暴力\u0026quot;的突破能力，再完美的缓解措施都将沦为数字时代的马奇诺防线。\n","keywords":[],"articleBody":"\n在安全研究人员的共同努力下，越发严格的安全缓解措施，已经把大部分内存漏洞扼杀在了摇篮之中。\n是时候宣布内存漏洞成为过去式了？\n2024年7月，一枚来自Windows阵营的\"核弹\"打破了安全的幻象。我们不禁发问：面对来自内存的威胁，眼前的城墙究竟能抵挡些什么？\n以下为本期《深蓝洞察 | 2024 年度安全报告》的第四篇。\n2024年5月，Lewis Lee、Chunyang Han和Zhiniang Peng向微软报告了一个存在于Windows Server RDL (Remote Desktop Licensing)服务中的漏洞。7月，该漏洞被修复并出现在公众视野。\n一石激起千重浪，作为一个无需认证、无需用户交互即可触发远程代码执行的内存破坏漏洞，它一经出现便迅速激起各大安全厂商与从业者的高度关注，一度被称作\"核弹级漏洞\"。\n这就是本篇的主角——狂躁许可（MadLicense）。\n尽管该漏洞起初被认为是比肩\"永恒之蓝\"的存在，经调研发现，它的影响范围实际上相对有限。该漏洞存在于Windows Server上的RDL服务而非通常认为的RDP协议。该服务仅作为一个可选安装项，用于允许多个用户通过RDP连接到服务器，与大部分个人用户关系不大。此外该漏洞存在于用户态，单个漏洞对系统的威胁能力较为有限。\n漏洞的成因是远程未授权用户能通过RPC远程调用RDL服务中的TLSRpcTelephoneRegisterLKP函数。该函数的子函数中对用户的部分输入进行base24到base10的解码，该功能并没有对输入长度进行限制，导致了一个无长度限制的堆溢出漏洞。\n作为一个内存破坏漏洞，它的破坏力不容小觑。于是我们立即着手进行复现，并试图探究，在内存漏洞式微、安全缓解措施愈发严格的今天，要在最新Windows平台利用这样一个经典的堆溢出漏洞，会遇到哪些阻碍和挑战？\n复现结果如图。攻击机（右侧）运行恶意脚本，在受害者主机未进行任何操作的情况下，可稳定地拿下远程主机的控制权（左侧shell）。\n自Windows 10引入的segment heap堆实现机制，被广泛应用在系统进程中。对于常用尺寸内存的分配，使用VS(Variable Size)或LFH(Low Fragmentation Heap)分配器实现。\nVS分配器对于溢出的防护机制较为完善。对于每个堆块，块首中的重要信息均被加密；空闲堆块间的连接也由安全性更高的数据结构代替。这些保护机制使得漏洞利用需要一定程度的信息泄露，大大提升了攻击门槛。\n然而当某一尺寸达到一定分配次数时，堆块分配会转为使用效率更高的LFH进行实现。\n相较VS，LFH的防护机制相对宽松。LFH堆块不存在块首，因此可以毫无阻碍地溢出到相邻堆块。为了缓解这一利用，LFH的分配采用了完全的随机化：堆块布局随机，且重用最近释放的堆块也不再可靠。这一点可以通过堆喷射的技巧进行绕过。\n在狂躁许可漏洞造成的无限制堆溢出面前，segment heap的防御机制被轻易击穿了。我们依然可以轻易溢出到目标堆块，伪造对象以获取任意地址读写/任意地址调用的原语。\n到这里利用还没有结束。接下来面对的通用内存缓解措施表现会如何？\n微软在Windows 8.1 Update 3和Windows 10中引入了一项重量级的缓解措施——控制流保护（CFG）。在启用CFG后，间接调用会使用编译期间生成的位图进行验证，确保仅对进程中加载模块的函数入口处进行调用，从而有效阻断了传统的代码片段重用攻击。\n另一个在Windows 10被引入的缓解措施是任意代码防护（ACG）。ACG可防止现有代码被修改，同时阻止了动态分配可执行内存。ACG与CFG同时开启的情况下，同时绕过这两大防护变得格外困难，几乎杜绝了传统的写入执行shellcode的可能性。\n需要注意的是，这两个机制并不能防止攻击者调用CreateProcessA等可能被滥用的函数。在不绕过以上内存缓解措施的情况下，任意函数调用已经足够允许我们在目标机上执行任意命令。\n而漏洞原作者之一，华中科技大学副教授彭峙酿向我们透露，他们能够近100%稳定利用、执行任意shellcode。这意味着以上内存缓解措施依然存在被绕过的可能。\n为何在采用最新缓解措施的Windows Server 2025上，此内存漏洞依然能被完整利用？\n彭峙酿这样回答：目前在Windows众多最新缓解措施全开的情况下，由一个内存破坏漏洞实现远程利用，正常来说是极难的。很多漏洞已不存在被利用的路径，或路径极少极隐蔽。\n但这并不代表目前的缓解措施杀死了所有的漏洞利用。能否完成利用往往取决于：攻击者为了完成利用所愿意投入的时间、对相关代码模块的熟悉程度、漏洞和具体模块的特殊情况。\nDeepSeek锐评 微软对狂躁许可漏洞\"几乎不可能利用\"的傲慢断言，折射出安全行业长期存在的评估悖论：当漏洞评级体系脱离攻击者视角，便沦为自欺欺人的技术乌托邦。\n防御者用静态指标丈量动态攻防，用理论模型否定实战可能，恰是安全防御最大的盲区。此次漏洞利用链突破多重内存防护的实践证明，安全评估不应是厂商的\"免责声明\"，而应成为攻防对抗的动态标尺。若不能正视攻击者\"技术暴力\"的突破能力，再完美的缓解措施都将沦为数字时代的马奇诺防线。\n","wordCount":"52","inLanguage":"zh","image":"https://www.darknavy.org/zh/darknavy_insight/the_maddest_vulnerability_of_2024/attachments/970c2c86-bd62-4753-9cbc-87c8c0a5af7f.webp","datePublished":"2025-02-11T11:41:45+08:00","dateModified":"2025-02-11T11:41:45+08:00","author":{"@type":"Person","name":"DARKNAVY"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.darknavy.org/zh/darknavy_insight/the_maddest_vulnerability_of_2024/"},"publisher":{"@type":"Organization","name":"DARKNAVY","logo":{"@type":"ImageObject","url":"https://www.darknavy.org/images/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://www.darknavy.org/zh/ accesskey=h title="  (Alt + H)"><img src=https://www.darknavy.org/images/darknavy_shenlan_dot.png alt aria-label=logo height=20></a><div class=logo-switches><ul class=lang-switch><li>|</li><li><a href=https://www.darknavy.org/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://www.darknavy.org/zh/ title=Home><span>Home</span></a></li><li><a href=https://www.darknavy.org/zh/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://www.darknavy.org/zh/darknavy_insight/ title=Insight><span>Insight</span></a></li><li><a href=https://www.darknavy.org/zh/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.darknavy.org/zh/>主页</a>&nbsp;»&nbsp;<a href=https://www.darknavy.org/zh/darknavy_insight/>深蓝洞察</a></div><h1 class="post-title entry-hint-parent">2024年度最狂躁不安的漏洞</h1><div class=post-meta><span title='2025-02-11 11:41:45 +0800 CST'>二月 11, 2025</span>&nbsp;·&nbsp;52 字&nbsp;·&nbsp;DARKNAVY&nbsp;|&nbsp;语言:<ul class=i18n_list><li><a href=https://www.darknavy.org/darknavy_insight/the_maddest_vulnerability_of_2024/>En</a></li></ul></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#deepseek锐评>DeepSeek锐评</a></li></ul></nav></div></details></div><div class=post-content><p><img loading=lazy src=/zh/darknavy_insight/the_maddest_vulnerability_of_2024/attachments/8d7f8b1c-b32a-4943-9b1d-fcdcf71c6a1e.webp></p><p>在安全研究人员的共同努力下，越发严格的安全缓解措施，已经把大部分内存漏洞扼杀在了摇篮之中。</p><p>是时候宣布内存漏洞成为过去式了？</p><p>2024年7月，一枚来自Windows阵营的"核弹"打破了安全的幻象。我们不禁发问：面对来自内存的威胁，眼前的城墙究竟能抵挡些什么？</p><p>以下为本期《深蓝洞察 | 2024 年度安全报告》的第四篇。</p><p><img loading=lazy src=/zh/darknavy_insight/the_maddest_vulnerability_of_2024/attachments/970c2c86-bd62-4753-9cbc-87c8c0a5af7f.webp></p><p>2024年5月，Lewis Lee、Chunyang Han和Zhiniang Peng向微软报告了一个存在于Windows Server RDL (Remote Desktop Licensing)服务中的漏洞。7月，该漏洞被修复并出现在公众视野。</p><p>一石激起千重浪，作为一个<strong>无需认证、无需用户交互</strong>即可触发<strong>远程代码执行</strong>的内存破坏漏洞，它一经出现便迅速激起各大安全厂商与从业者的高度关注，一度被称作"<strong>核弹级漏洞"</strong>。</p><p>这就是本篇的主角——<strong>狂躁许可（MadLicense）</strong>。</p><p>尽管该漏洞起初被认为是比肩"永恒之蓝"的存在，经调研发现，它的影响范围实际上相对有限。该漏洞存在于Windows Server上的RDL服务而非通常认为的RDP协议。该服务仅作为一个可选安装项，用于允许多个用户通过RDP连接到服务器，<strong>与大部分个人用户关系不大</strong>。此外该漏洞存在于用户态，单个漏洞对系统的威胁能力较为有限。</p><p>漏洞的成因是远程未授权用户能通过RPC远程调用RDL服务中的<code>TLSRpcTelephoneRegisterLKP</code>函数。该函数的子函数中对用户的部分输入进行base24到base10的解码，该功能并没有对输入长度进行限制，导致了一个<strong>无长度限制的堆溢出漏洞</strong>。</p><p>作为一个内存破坏漏洞，它的破坏力不容小觑。于是我们立即着手进行复现，并试图探究，在<strong>内存漏洞式微、安全缓解措施愈发严格</strong>的今天，要在最新Windows平台利用这样一个经典的堆溢出漏洞，会遇到哪些阻碍和挑战？</p><p><video src=attachments/617e65a7-5214-477b-8e75-72b67899a97f.mp4 controls width=100% height=auto></video></p><p>复现结果如图。攻击机（右侧）运行恶意脚本，在受害者主机未进行任何操作的情况下，可稳定地拿下远程主机的控制权（左侧shell）。</p><p>自Windows 10引入的<strong>segment heap</strong>堆实现机制，被广泛应用在系统进程中。对于常用尺寸内存的分配，使用VS(Variable Size)或LFH(Low Fragmentation Heap)分配器实现。</p><img src=attachments/4269c94f-503f-4b61-9e69-2ad0390aac70.webp style=display:block;margin-left:auto;margin-right:auto;zoom:30%><p>VS分配器对于溢出的防护机制较为完善。对于每个堆块，块首中的重要信息均被加密；空闲堆块间的连接也由安全性更高的数据结构代替。这些保护机制使得漏洞利用需要一定程度的信息泄露，大大提升了攻击门槛。</p><p>然而当某一尺寸达到一定分配次数时，堆块分配会转为使用效率更高的LFH进行实现。</p><p>相较VS，LFH的防护机制相对宽松。LFH堆块不存在块首，因此可以毫无阻碍地溢出到相邻堆块。为了缓解这一利用，LFH的分配采用了完全的随机化：堆块布局随机，且重用最近释放的堆块也不再可靠。这一点可以通过堆喷射的技巧进行绕过。</p><p>在狂躁许可漏洞造成的无限制堆溢出面前，segment heap的防御机制被轻易击穿了。我们依然可以轻易溢出到目标堆块，伪造对象以获取<strong>任意地址读写/任意地址调用</strong>的原语。</p><p>到这里利用还没有结束。接下来面对的通用内存缓解措施表现会如何？</p><p>微软在Windows 8.1 Update 3和Windows 10中引入了一项重量级的缓解措施——<strong>控制流保护（CFG）</strong>。在启用CFG后，间接调用会使用编译期间生成的位图进行验证，确保仅对进程中加载模块的函数入口处进行调用，从而有效阻断了传统的代码片段重用攻击。</p><p>另一个在Windows 10被引入的缓解措施是<strong>任意代码防护（ACG）</strong>。ACG可防止现有代码被修改，同时阻止了动态分配可执行内存。ACG与CFG同时开启的情况下，同时绕过这两大防护变得格外困难，几乎杜绝了传统的写入执行shellcode的可能性。</p><p>需要注意的是，这两个机制并不能防止攻击者调用<code>CreateProcessA</code>等可能被滥用的函数。在不绕过以上内存缓解措施的情况下，任意函数调用已经足够允许我们在目标机上执行任意命令。</p><p>而漏洞原作者之一，华中科技大学副教授彭峙酿向我们透露，他们能够<strong>近100%稳定利用、执行任意shellcode</strong>。这意味着以上内存缓解措施依然存在被绕过的可能。</p><p>为何在采用最新缓解措施的Windows Server 2025上，此内存漏洞依然能被完整利用？</p><blockquote><p><strong>彭峙酿这样回答</strong>：目前在Windows众多最新缓解措施全开的情况下，由一个内存破坏漏洞实现远程利用，正常来说是极难的。很多漏洞已不存在被利用的路径，或路径极少极隐蔽。</p><p>但这并不代表目前的缓解措施杀死了所有的漏洞利用。能否完成利用往往取决于：攻击者为了完成利用所愿意投入的时间、对相关代码模块的熟悉程度、漏洞和具体模块的特殊情况。</p></blockquote><hr><h2 id=deepseek锐评>DeepSeek锐评<a hidden class=anchor aria-hidden=true href=#deepseek锐评>#</a></h2><p>微软对狂躁许可漏洞"几乎不可能利用"的傲慢断言，折射出安全行业长期存在的评估悖论：当漏洞评级体系脱离攻击者视角，便沦为自欺欺人的技术乌托邦。</p><p>防御者用静态指标丈量动态攻防，用理论模型否定实战可能，恰是安全防御最大的盲区。此次漏洞利用链突破多重内存防护的实践证明，安全评估不应是厂商的"免责声明"，而应成为攻防对抗的动态标尺。若不能正视攻击者"技术暴力"的突破能力，再完美的缓解措施都将沦为数字时代的马奇诺防线。</p><hr></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.darknavy.org/zh/>DARKNAVY</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>