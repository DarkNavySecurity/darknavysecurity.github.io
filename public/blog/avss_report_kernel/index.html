<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>AVSS Report: System Security Adversarial Capability Preliminary Evaluation of iOS, Android, and HarmonyOS - Kernel | DARKNAVY</title><meta name=keywords content><meta name=description content="As consumers, when faced with five different brands and models of smartphones or ten different smart cars, it&rsquo;s difficult for us to determine which one can effectively prevent our privacy from being stolen or maliciously accessed, such as our location or even hearing our conversations inside the car.
Even as ordinary consumers, we currently have no way of knowing. As technology professionals who have long studied in APT(Advanced Persistent Threat) attacks, we understand that these devices can ultimately be compromised in the face of advanced persistent attacks."><meta name=author content="DARKNAVY"><link rel=canonical href=https://www.darknavy.org/blog/avss_report_kernel/><link crossorigin=anonymous href=/assets/css/stylesheet.dc70557db50709d4e62a748e3431ee3a493e2bb592a0de8cae0eea492fbee8cb.css integrity="sha256-3HBVfbUHCdTmKnSONDHuOkk+K7WSoN6Mrg7qSS++6Ms=" rel="preload stylesheet" as=style><link rel=icon href=https://www.darknavy.org/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.darknavy.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.darknavy.org/favicon-32x32.png><link rel=apple-touch-icon href=https://www.darknavy.org/apple-touch-icon.png><link rel=mask-icon href=https://www.darknavy.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.darknavy.org/blog/avss_report_kernel/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-LR4ZN1LSPS"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LR4ZN1LSPS")}</script><meta property="og:url" content="https://www.darknavy.org/blog/avss_report_kernel/"><meta property="og:site_name" content="DARKNAVY"><meta property="og:title" content="AVSS Report: System Security Adversarial Capability Preliminary Evaluation of iOS, Android, and HarmonyOS - Kernel"><meta property="og:description" content="As consumers, when faced with five different brands and models of smartphones or ten different smart cars, it’s difficult for us to determine which one can effectively prevent our privacy from being stolen or maliciously accessed, such as our location or even hearing our conversations inside the car.
Even as ordinary consumers, we currently have no way of knowing. As technology professionals who have long studied in APT(Advanced Persistent Threat) attacks, we understand that these devices can ultimately be compromised in the face of advanced persistent attacks."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-06-11T15:40:57+08:00"><meta property="article:modified_time" content="2024-06-11T15:40:57+08:00"><meta property="og:image" content="https://www.darknavy.org/images/white_logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.darknavy.org/images/white_logo.png"><meta name=twitter:title content="AVSS Report: System Security Adversarial Capability Preliminary Evaluation of iOS, Android, and HarmonyOS - Kernel"><meta name=twitter:description content="As consumers, when faced with five different brands and models of smartphones or ten different smart cars, it&rsquo;s difficult for us to determine which one can effectively prevent our privacy from being stolen or maliciously accessed, such as our location or even hearing our conversations inside the car.
Even as ordinary consumers, we currently have no way of knowing. As technology professionals who have long studied in APT(Advanced Persistent Threat) attacks, we understand that these devices can ultimately be compromised in the face of advanced persistent attacks."><meta name=twitter:site content="@DarkNavyOrg"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://www.darknavy.org/blog/"},{"@type":"ListItem","position":2,"name":"AVSS Report: System Security Adversarial Capability Preliminary Evaluation of iOS, Android, and HarmonyOS - Kernel","item":"https://www.darknavy.org/blog/avss_report_kernel/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AVSS Report: System Security Adversarial Capability Preliminary Evaluation of iOS, Android, and HarmonyOS - Kernel","name":"AVSS Report: System Security Adversarial Capability Preliminary Evaluation of iOS, Android, and HarmonyOS - Kernel","description":"As consumers, when faced with five different brands and models of smartphones or ten different smart cars, it\u0026rsquo;s difficult for us to determine which one can effectively prevent our privacy from being stolen or maliciously accessed, such as our location or even hearing our conversations inside the car.\nEven as ordinary consumers, we currently have no way of knowing. As technology professionals who have long studied in APT(Advanced Persistent Threat) attacks, we understand that these devices can ultimately be compromised in the face of advanced persistent attacks.\n","keywords":[],"articleBody":"As consumers, when faced with five different brands and models of smartphones or ten different smart cars, it’s difficult for us to determine which one can effectively prevent our privacy from being stolen or maliciously accessed, such as our location or even hearing our conversations inside the car.\nEven as ordinary consumers, we currently have no way of knowing. As technology professionals who have long studied in APT(Advanced Persistent Threat) attacks, we understand that these devices can ultimately be compromised in the face of advanced persistent attacks.\nVulnerabilities can never be completely eliminated. The goal of all security efforts is to increase the cost for attackers as much as possible, including time, computational power, skills, and so on.\nThis is the original intention of our efforts to promote the AVSS (Adversarial Vulnerability Scoring System) evaluation framework. We hope to promote the measurability and perceptibility of security values through scientific and fair quantification of security, striving to increase the cost for attackers and protect the products and enterprises that should be seen by consumers. Consumers also have the right to make more secure choices more conveniently.\nAVSS Report This report by DARKNAVY is based on the AVSS concept with an advanced persistent adversarial attack perspective. The following device systems are evaluated from the five stages of kernel security countermeasures of mobile operating systems: 1. Locating the attack entry; 2. Construct primitives; 3. Bypass kernel monitoring; 4. Lateral movement; 5. Full system control.\nThe operating systems on the tested devices are the latest versions as of May 2024. HarmonyOS NEXT Developer Preview2 is the HarmonyOS with Huawei’s self-developed kernel. We will use HarmonyOS NEXT to refer to HarmonyOS NEXT Developer Preview2 in the following text.\nAVSS Conclusion HarmonyOS 4.2 demonstrates slightly superior overall security compared to operating system kernels such as native Android 14 and ONE UI 6. Additionally, in several dimensions, it approaches or matches the capability index of iOS 17.\nHarmonyOS NEXT adopts a new microkernel architecture, showing significant progress in certain dimensions such as post-exploitation inter-module lateral movement, while there is still room for improvement in traditional security aspects, such as memory corruption defense.\nThe quantified indices above are based on adversarial evaluations of the following five major categories of kernel security defense capabilities, comprising over 50 defense quantification dimensions and indicators:\nA. Kernel and user mode attack surface defense capability\nB. Kernel memory corruption vulnerability defense capability\nC. Kernel arbitrary read and write exploit defense capability\nD. Inter-module lateral movement defense capability\nE. Defense-in-depth capability Stage 1: Locating attack surface and finding vulnerabilities – Kernel and user mode attack surface defense capability\nAttackers first need to determine the kernel resources they can access and identify vulnerabilities within those resources. The fewer unnecessary resources the kernel exposes, the fewer potential vulnerabilities exist.\nStage 2: Using the vulnerability to “do evil things” - Kernel memory corruption vulnerability defense capability\nAttackers typically discover vulnerabilities through coding flaws. Attackers need to craft sophisticated exploits to turn these coding flaws into accesses to sensitive kernel data. The kernel can prevent these coding flaws from evolving into harmful operations by adding checks during design, implementation, and compilation to guard against unexpected code behavior.\nStage 3: Bypassing the kernel’s “patrolling guards” - Kernel arbitrary read and write exploit defense capability\nSome kernels set up additional, real-time guards for critical code and data – runtime integrity monitoring. Attackers need to bypass these guards or find alternative routes to complete their attacks.\nStage 4: Inter-module lateral movement - Lateral movement defense capability\nOnce an attacker breaches a kernel resource within a functional module, the kernel’s separation and isolation of functional modules ensure that the compromised module is isolated from other functioning modules.\nStage 5: Persistent residence, sensitive information theft - Defense-in-depth capability\nIn some systems, the kernel is the lowest layer managing user data. If the kernel is breached, it means all user data can be controlled by the attacker. However, some advanced operating systems implement multiple measures beneath the kernel to protect critical user-sensitive data.\nAVSS Review Kernel and User-Mode Attack Surface Defense Capability Index This index corresponds to the first phase: the defense capability against locating attack surfaces and finding vulnerabilities within them.\nThe kernel of HarmonyOS 4.2 has a defense capability against user-mode attack surfaces comparable to that of native Android 14, One UI 6, and iOS 17 operating system kernels, all of which deploy mature security defense mechanisms.\nThe HarmonyOS NEXT version surpasses other operating system kernels in defending against user-mode attack surfaces. Its microkernel architecture significantly reduces the amount of code running at privileged levels, thereby lowering the risk of vulnerabilities.\nThe primary threats faced by operating system kernels come from user-mode programs. For attackers, the degree of restriction on kernel resources accessible to user-mode, and the amount of code running at a high privilege level in the kernel, are crucial factors influencing the difficulty of their attacks.\nThe kernel provides user-mode programs with extensive resource access interfaces, such as system calls, drivers, procfs, and sysfs. All interfaces exposed to user-mode programs become potential attack surfaces. By implementing access controls on user-mode programs, the kernel can isolate system programs from untrusted applications. This reduces the number of kernel interfaces exposed to untrusted applications, minimizes the direct attack surface, and increases the cost and difficulty for attackers. The amount of code running at high privilege levels is proportional to the number of high-privilege vulnerabilities. Different kernel architectures result in varying amounts of kernel-mode code, which leads to significant differences in the number of vulnerabilities. HarmonyOS 4.2 uses mature security defense mechanisms such as SELinux, Seccomp, Namespace, and Capability (iOS 17 uses Sandbox and Entitlement to achieve similar effects). HarmonyOS NEXT has designed a CAPABILITY SYSTEM on top of existing defense mechanisms to restrict access to kernel functions and verify IPC permissions.\nIn HarmonyOS NEXT, kernel objects are used as carriers for data transmission during IPC communication. The CAPABILITY SYSTEM ensures that only those with the capability to read from or write to kernel objects can receive or send messages through these objects. As a result, the content of messages cannot be accessed by malicious processes.\nHarmonyOS NEXT adopts a microkernel architecture, effectively reducing the kernel TCB (Trusted Code Base). Compared to traditional monolithic kernels, the kernel code in HarmonyOS NEXT is less than one-fourth in size, significantly reducing the occurrence of vulnerabilities. Below is a comparison of the TCB sizes of the evaluated operating system kernels:\nKernel Memory Corruption Vulnerability Defense Capability Index This index corresponds to Phase Two: the capability to defend against exploiting vulnerabilities to “do evil things.”\nFor memory corruption vulnerabilities, the HarmonyOS 4.2 kernel is exceptionally well-defended compared to conventional mobile kernels. In addition to standard kernel defense mechanisms, HarmonyOS 4.2 employs Pointer Authentication Codes (PAC) and Control Flow Integrity (CFI) for more comprehensive protection. However, these PAC and CFI defense mechanisms are not utilized in HarmonyOS NEXT, leaving it vulnerable to attacks that could compromise the execution logic of kernel code. It is recommended that HarmonyOS NEXT adopt these mature defense mechanisms to further enhance its kernel security.\nAt present, the main way of kernel attack is still to use memory corruption vulnerability to escalate privilege through kernel data reading and writing and kernel code execution. Therefore, the kernel’s defense against memory corruption vulnerabilities is an important part of kernel security.\nThe occurrence of vulnerabilities is inevitable, but after long-term development, some vulnerability types can be eliminated from the source by relying on compilers, heap allocators and various parameter settings, and the use of these defense mitigations can prevent attackers from mining this type of vulnerabilities.\nThe degree of the security defense mechanism is closely related to the difficulty of the attacker to carry out attacks. For example, with the same stack overflow vulnerability, it is much more difficult for an attacker to attack targets with the stack canary than targets without the canary.\nThe causes of vulnerabilities are various, but the means of exploiting vulnerabilities are relatively traceable. Discovering and blocking such means in time during exploitation will increase the attack cost and difficulty of attackers.\nIn addition to enabling established kernel defense mechanisms such as NX/DEP, PXN/PAN, and Canary, HarmonyOS 4.2 also employs CFI to protect indirect jumps and PAC to safeguard the return addresses of non-leaf nodes. Compared to native Android 14 and One UI 6, HarmonyOS 4.2 offers more comprehensive protection.\nDuring testing, DARKNAVY found that HarmonyOS NEXT does not utilize PAC, CFI, and other defense mechanisms already deployed in HarmonyOS 4.2.\nPAC (Pointer Authentication Code) is a security feature introduced in the ARM architecture. It is signed by inserting an additional signature into the pointer to verify the integrity of the pointer, thus resisting JOP, ROP and other attacks.\nHarmonyOS Version 4.2 uses PAC to protect the return addresses of non-leaf nodes as follows:\nThere is a ptrauth_keys_kernel structure in the kernel code, and there is a ptrauth_key structure in the structure. When each process is created, the kernel will execute a ptrauth_keys_init_kernel function. This function writes the random number 16 bytes to the key_kernel field of the thread struct of task_struct by get_ramdom_bytes. When the process invokes the kernel system call, Perform switch_to will write __pki_v.lo and __pki_v.li in key_kernel field in task_struct . The PACIASP instruction and AUTIASP instruction use the register __pki_v to calculate values written to the stack to ensure that the return address is not tampered with.\nHarmonyOS version 4.2 Separates the user PAC key from the kernel PAC key, both algorithms are the same. If an attacker can modify the user PAC key to the kernel PAC key, it may lead to control of the kernel execution flow. User-mode kernel mode algorithm isolation is recommended.\nstruct ptrauth_keys_kernel { struct ptrauth_key apia; }; static __always_inline void ptrauth_keys_init_kernel(struct ptrauth_keys_kernel *keys) { if (system_supports_address_auth()) get_random_bytes(\u0026keys-\u003eapia, sizeof(keys-\u003eapia)); } static __always_inline void ptrauth_keys_switch_kernel(struct ptrauth_keys_kernel *keys) { if (!system_supports_address_auth()) return; __ptrauth_key_install_nosync(APIA, keys-\u003eapia); isb(); } Contemporary kernel attack methods have evolved significantly from traditional techniques. The introduction of Stack Canary, PAC, and CFI has greatly improved control flow integrity, making direct control flow hijacking attacks on the kernel increasingly rare.\nIn recent years, kernel privilege escalation attacks have more commonly targeted data-oriented attacks. These attacks exploit UAF (Use After Free) and OOB (Out Of Bounds) vulnerabilities to modify data pointers within the kernel, enabling arbitrary kernel address reads and writes, altering critical data structures, and escalating privileges. iOS 17 leverages hardware security features provided by its processors to implement Data PAC, and Pixel 8 uses ARM MTE in native Android, significantly enhancing defense capabilities against data-oriented attacks. However, HarmonyOS has not yet adopted these mechanisms.\nKernel Arbitrary Read/Write Exploit Defense Capability Index This index corresponds to stage 3: the ability to bypass the “patrolling guards” in the kernel\nThe kernel code and key data protection in HarmonyOS 4.2 is more advanced than in HarmonyOS NEXT and far ahead of native Android 14. It utilizes the self-developed HKIP mechanism (similar to RKP) to protect the critical kernel data. Additionally, SPTM for iOS, implemented based on hardware features, has a smaller attack surface.\nWith the continuous improvement of defense mechanisms such as PAC and CFI, the integrity of kernels control flow has been better protected, and the attack mode of hijacking kernel control flow has become rare. In recent years, a more common method is through data-oriented Attack, that is, by obtaining the arbitrary data reading and writing ability of the kernel, modifying the critical kernel data to escalate privilege. Therefore, after the attacker obtains the arbitrary read and write ability of the kernel, how to counter further attacks is the core capability of kernel security.\nThere are a large number of sensitive data and segments in the kernel, such as kernel code segments, which are the most priority targets for attackers. Once an attacker can tamper with the data of kernel code segments, he can obtain arbitrary execution permission of the kernel. The operating system can protect the integrity of kernel data from a higher level, which can effectively increase the difficulty of the attacker.\nRKP stands for “Real-time Kernel Protection” and is the name of Samsung’s EL2 Layer defense mechanism, which is part of Samsung KNOX. The emergence of the RKP mechanism has significantly increased the difficulty for attackers, making traditional exploit methods even less effective against RKP. The following is the page table address translation diagram in RKP:\nHarmonyOS 4.2 also uses HKIP mechanism to protect the integrity of kernel code segments and read-only data segments from the EL2 level. It creates read-only memory through mmap to store important structural data and pointers in the kernel and uses HKIP to protect the integrity of the memory. The principle is similar to RKP. In both cases, an additional layer of page table mapping is made at the EL2 layer to ensure that changes to the page table at the EL1 layer can be captured and intercepted by the EL2 layer.\nThe HKIP mechanism in HarmonyOS version 4.2 has the same protection capability as the RKP mechanism, which protects code segments, read-only data segments, and important structures of the kernel from tampering. However, for the lack of protection of the application page table, the attacker can arbitrarily read and write the physical address that is not protected by HKIP by modifying the application’s page table. This exploitation method has also been verified to be feasible on Pixel and Samsung Galaxy.\nIn HarmonyOS NEXT, HKIP provides various protection mechanisms. However, actual research has found that, apart from the code segment, read-only data segment, and kernel page table, other critical structures are not protected by HKIP.\nThe following is a comparison of the coverage of defense capabilities in some HKIP mechanisms and RKP mechanisms:\n（o : cover x : not cover | : incomplete cover）\nLateral Movement Defense Capability The index corresponds to stage 4: the defense capability of the inter-module lateral movement\nThe HarmonyOS 4.2 kernel is similar to the native Android 14 and ONE UI 6 kernel, and there is no strict permission isolation between major kernel modules, while iOS is based on a hybrid kernel architecture of Mach and BSD.\nHarmonyOS NEXT uses a microkernel architecture with finer-grained kernel module isolation, which divides kernel resources into multiple types, different types are managed by corresponding modules, and modules communicate with each other through the IPC mechanism, which has a better effect on multiple modules defense against attacks.\nThe kernel of the traditional operating system is responsible for the scheduling of all resources of the entire system, and once the corruption of any module of the kernel will lead to the loss of the entire operating system. With the birth of the microkernel, the permission division of the kernel module is finer-grained, so how to reduce the influence of post-exploitation diffusion has become a new measurement index of kernel security.\nNetwork module, file management module, memory management module, driver module, etc. are the main attack targets of attackers. The fine-grained division of their permissions can effectively prevent attackers from spreading attacks from the point to the surface.\nHarmonyOS NEXT divides the permissions between modules in a fine-grained manner and communicates between modules through IPC, making it difficult for attackers to evolve the attack results of one module into the attack results of the entire system.\nHarmonyOS NEXT loads the driver in user mode, making it difficult to convert an attack against the driver to an attack against the kernel EL1 layer by obtaining only EL0 permissions.\nDefense-in-depth capability The index corresponds to stage 5: persistent resident, information theft defense capability\nBoth HarmonyOS 4.2 and HarmonyOS NEXT adopt a defense-in-depth design under the kernel. They are hardened with higher-privilege hypervisors, secure monitor, TrustZone, security elements, and security chips that are isolated from the kernel. Even if an attacker can compromise the kernel, it can still protect sensitive information such as biometric information and critical keys.\nHarmonyOS NEXT also improves file system protection, using different keys for different contexts to protect the confidentiality and integrity of code and data files, and key management with the Secure Enclave (TrustZone, security chip) isolated from the kernel.\nDefense in depth has been widely practiced on mobile devices, and manufacturers and system developers can use hardware security primitives and chip designs provided by processors to achieve a higher level of security privileges than the kernel. Even after an attacker compromises the kernel, the system relies on a hypervisor or secure monitor that is lower than the kernel and has a smaller TCB. The TrustZone and security chip, which are isolated from the kernel, still ensure the security of users’ sensitive data.\nDescription and Notice This report provides a preliminary adversarial analysis of the kernel defense mechanisms of each mobile operating system and does not conduct AVSS best practices, so the current version of the report does not contain evaluation scores and composite scores for all indicator subitems.\nIn addition, DARKNAVY based on the DAF (DarkNavy Adversarial Framework) framework, obtained the root permission of HarmonyOS NEXT system, to make the above horizontal and vertical preliminary quantitative evaluation analysis.\n[Next Episode Preview] How does the security capability of new operating systems perform against malicious exploit methods such as intrusive pop-up ads, background process persistence, and privacy theft? Stay tuned for the upcoming AVSS research report: “Multi-Mobile Platform Operating System Security Adversarial Capability Preliminary Evaluation Report - Application” as well as the release of the HarmonyOS NEXT APP Decompiler.\n","wordCount":"2904","inLanguage":"en","image":"https://www.darknavy.org/images/white_logo.png","datePublished":"2024-06-11T15:40:57+08:00","dateModified":"2024-06-11T15:40:57+08:00","author":{"@type":"Person","name":"DARKNAVY"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.darknavy.org/blog/avss_report_kernel/"},"publisher":{"@type":"Organization","name":"DARKNAVY","logo":{"@type":"ImageObject","url":"https://www.darknavy.org/images/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://www.darknavy.org/ accesskey=h title="  (Alt + H)"><img src=https://www.darknavy.org/images/darknavy_shenlan_dot.png alt aria-label=logo height=20></a><div class=logo-switches><ul class=lang-switch><li>|</li><li><a href=https://www.darknavy.org/zh/ title=Chinese aria-label=Chinese>Zh</a></li></ul></div></div><ul id=menu><li><a href=https://www.darknavy.org/ title=Home><span>Home</span></a></li><li><a href=https://www.darknavy.org/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://www.darknavy.org/darknavy_insight/ title=Insight><span>Insight</span></a></li><li><a href=https://www.darknavy.org/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.darknavy.org/>Home</a>&nbsp;»&nbsp;<a href=https://www.darknavy.org/blog/>Blog</a></div><h1 class="post-title entry-hint-parent">AVSS Report: System Security Adversarial Capability Preliminary Evaluation of iOS, Android, and HarmonyOS - Kernel</h1><div class=post-meta><span title='2024-06-11 15:40:57 +0800 CST'>June 11, 2024</span>&nbsp;·&nbsp;2904 words&nbsp;·&nbsp;DARKNAVY</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#avss-report>AVSS Report</a></li><li><a href=#avss-conclusion>AVSS Conclusion</a></li><li><a href=#avss-review>AVSS Review</a><ul><li><a href=#kernel-and-user-mode-attack-surface-defense-capability-index>Kernel and User-Mode Attack Surface Defense Capability Index</a></li><li><a href=#kernel-memory-corruption-vulnerability-defense-capability-index>Kernel Memory Corruption Vulnerability Defense Capability Index</a></li><li><a href=#kernel-arbitrary-readwrite-exploit-defense-capability-index>Kernel Arbitrary Read/Write Exploit Defense Capability Index</a></li><li><a href=#lateral-movement-defense-capability>Lateral Movement Defense Capability</a></li><li><a href=#defense-in-depth-capability>Defense-in-depth capability</a></li></ul></li><li><a href=#description-and-notice>Description and Notice</a></li></ul></nav></div></details></div><div class=post-content><p>As consumers, when faced with five different brands and models of smartphones or ten different smart cars, it&rsquo;s difficult for us to determine which one can effectively prevent our privacy from being stolen or maliciously accessed, such as our location or even hearing our conversations inside the car.</p><p>Even as ordinary consumers, we currently have no way of knowing. As technology professionals who have long studied in APT(Advanced Persistent Threat) attacks, we understand that these devices can ultimately be compromised in the face of advanced persistent attacks.</p><p>Vulnerabilities can never be completely eliminated. The goal of all security efforts is to increase the cost for attackers as much as possible, including time, computational power, skills, and so on.</p><p>This is the original intention of our efforts to promote the AVSS (Adversarial Vulnerability Scoring System) evaluation framework. We hope to promote the measurability and perceptibility of security values through scientific and fair quantification of security, striving to increase the cost for attackers and protect the products and enterprises that should be seen by consumers. Consumers also have the right to make more secure choices more conveniently.</p><h2 id=avss-report>AVSS Report<a hidden class=anchor aria-hidden=true href=#avss-report>#</a></h2><p>This report by DARKNAVY is based on the AVSS concept with an advanced persistent adversarial attack perspective. The following device systems are evaluated from the <strong>five stages</strong> of kernel security countermeasures of mobile operating systems: <strong>1. Locating the attack entry; 2. Construct primitives; 3. Bypass kernel monitoring; 4. Lateral movement; 5. Full system control.</strong></p><p><img loading=lazy src=/blog/avss_report_kernel/attachments/1.jpg></p><p>The operating systems on the tested devices are the latest versions as of May 2024. HarmonyOS NEXT Developer Preview2 is the HarmonyOS with Huawei&rsquo;s self-developed kernel. We will use HarmonyOS NEXT to refer to HarmonyOS NEXT Developer Preview2 in the following text.</p><h2 id=avss-conclusion>AVSS Conclusion<a hidden class=anchor aria-hidden=true href=#avss-conclusion>#</a></h2><ul><li><p>HarmonyOS 4.2 demonstrates <strong>slightly superior overall security compared to</strong> operating system kernels such as <strong>native Android 14 and ONE UI 6</strong>. Additionally, in several dimensions, it approaches or matches the capability index of iOS 17.</p></li><li><p>HarmonyOS NEXT adopts a new <strong>microkernel architecture</strong>, showing <strong>significant progress in certain dimensions</strong> such as post-exploitation inter-module lateral movement, while there is still <strong>room for improvement</strong> in traditional security aspects, such as memory corruption defense.</p><p><img loading=lazy src=/blog/avss_report_kernel/attachments/2.png></p></li></ul><p>The quantified indices above are based on adversarial evaluations of the following five major categories of kernel security defense capabilities, comprising over 50 defense quantification dimensions and indicators:</p><p>A. Kernel and user mode attack surface defense capability</p><p>B. Kernel memory corruption vulnerability defense capability</p><p>C. Kernel arbitrary read and write exploit defense capability</p><p>D. Inter-module lateral movement defense capability</p><p>E. Defense-in-depth capability
<img loading=lazy src=/blog/avss_report_kernel/attachments/3.png></p><p><strong>Stage 1: Locating attack surface and finding vulnerabilities &ndash; Kernel and user mode attack surface defense capability</strong></p><p>Attackers first need to determine the kernel resources they can access and identify vulnerabilities within those resources. The fewer unnecessary resources the kernel exposes, the fewer potential vulnerabilities exist.</p><p><strong>Stage 2: Using the vulnerability to &ldquo;do evil things&rdquo; - Kernel memory corruption vulnerability defense capability</strong></p><p>Attackers typically discover vulnerabilities through coding flaws. Attackers need to craft sophisticated exploits to turn these coding flaws into accesses to sensitive kernel data. The kernel can prevent these coding flaws from evolving into harmful operations by adding checks during design, implementation, and compilation to guard against unexpected code behavior.</p><p><strong>Stage 3: Bypassing the kernel&rsquo;s &ldquo;patrolling guards&rdquo; - Kernel arbitrary read and write exploit defense capability</strong></p><p>Some kernels set up additional, real-time guards for critical code and data – runtime integrity monitoring. Attackers need to bypass these guards or find alternative routes to complete their attacks.</p><p><strong>Stage 4: Inter-module lateral movement - Lateral movement defense capability</strong></p><p>Once an attacker breaches a kernel resource within a functional module, the kernel&rsquo;s separation and isolation of functional modules ensure that the compromised module is isolated from other functioning modules.</p><p><strong>Stage 5: Persistent residence, sensitive information theft - Defense-in-depth capability</strong></p><p>In some systems, the kernel is the lowest layer managing user data. If the kernel is breached, it means all user data can be controlled by the attacker. However, some advanced operating systems implement multiple measures beneath the kernel to protect critical user-sensitive data.</p><h2 id=avss-review>AVSS Review<a hidden class=anchor aria-hidden=true href=#avss-review>#</a></h2><h3 id=kernel-and-user-mode-attack-surface-defense-capability-index>Kernel and User-Mode Attack Surface Defense Capability Index<a hidden class=anchor aria-hidden=true href=#kernel-and-user-mode-attack-surface-defense-capability-index>#</a></h3><blockquote><p>This index corresponds to the first phase: the defense capability against locating attack surfaces and finding vulnerabilities within them.</p></blockquote><p>The kernel of HarmonyOS 4.2 has a defense capability against user-mode attack surfaces comparable to that of native Android 14, One UI 6, and iOS 17 operating system kernels, <strong>all of which deploy mature security defense mechanisms</strong>.</p><p>The HarmonyOS NEXT version surpasses other operating system kernels in defending against user-mode attack surfaces. Its microkernel architecture <strong>significantly reduces the amount of code running at privileged levels</strong>, thereby lowering the risk of vulnerabilities.</p><blockquote><p>The primary threats faced by operating system kernels come from user-mode programs. For attackers, the degree of restriction on kernel resources accessible to user-mode, and the amount of code running at a high privilege level in the kernel, are crucial factors influencing the difficulty of their attacks.</p><ul><li>The kernel provides user-mode programs with extensive resource access interfaces, such as system calls, drivers, procfs, and sysfs. All interfaces exposed to user-mode programs become potential attack surfaces. By implementing access controls on user-mode programs, the kernel can isolate system programs from untrusted applications. This reduces the number of kernel interfaces exposed to untrusted applications, minimizes the direct attack surface, and increases the cost and difficulty for attackers.</li><li>The amount of code running at high privilege levels is proportional to the number of high-privilege vulnerabilities. Different kernel architectures result in varying amounts of kernel-mode code, which leads to significant differences in the number of vulnerabilities.</li></ul></blockquote><p>HarmonyOS 4.2 uses mature security defense mechanisms such as <strong>SELinux, Seccomp, Namespace, and Capability</strong> (iOS 17 uses Sandbox and Entitlement to achieve similar effects). HarmonyOS NEXT has designed a <strong>CAPABILITY SYSTEM</strong> on top of existing defense mechanisms to restrict access to kernel functions and <strong>verify IPC permissions</strong>.</p><p>In HarmonyOS NEXT, kernel objects are used as carriers for data transmission during IPC communication. The CAPABILITY SYSTEM ensures that only those with the capability to read from or write to kernel objects can receive or send messages through these objects. As a result, the content of messages cannot be accessed by malicious processes.</p><p>HarmonyOS NEXT adopts a microkernel architecture, effectively reducing the kernel TCB (Trusted Code Base). Compared to traditional monolithic kernels, the kernel code in HarmonyOS NEXT is <strong>less than one-fourth in size</strong>, significantly reducing the occurrence of vulnerabilities. Below is a comparison of the TCB sizes of the evaluated operating system kernels:</p><p><img loading=lazy src=/blog/avss_report_kernel/attachments/4.png></p><h3 id=kernel-memory-corruption-vulnerability-defense-capability-index>Kernel Memory Corruption Vulnerability Defense Capability Index<a hidden class=anchor aria-hidden=true href=#kernel-memory-corruption-vulnerability-defense-capability-index>#</a></h3><blockquote><p>This index corresponds to Phase Two: the capability to defend against exploiting vulnerabilities to &ldquo;do evil things.&rdquo;</p></blockquote><p>For memory corruption vulnerabilities, the HarmonyOS 4.2 kernel is exceptionally well-defended compared to conventional mobile kernels. In addition to standard kernel defense mechanisms, HarmonyOS 4.2 employs Pointer Authentication Codes (PAC) and Control Flow Integrity (CFI) for more comprehensive protection. However, these PAC and CFI defense mechanisms are not utilized in HarmonyOS NEXT, leaving it vulnerable to attacks that could compromise the execution logic of kernel code. It is recommended that HarmonyOS NEXT adopt these mature defense mechanisms to further enhance its kernel security.</p><blockquote><p>At present, the main way of kernel attack is still to use memory corruption vulnerability to escalate privilege through kernel data reading and writing and kernel code execution. Therefore, the kernel&rsquo;s defense against memory corruption vulnerabilities is an important part of kernel security.</p><ul><li><p>The occurrence of vulnerabilities is inevitable, but after long-term development, some vulnerability types can be eliminated from the source by relying on compilers, heap allocators and various parameter settings, and the use of these defense mitigations can prevent attackers from mining this type of vulnerabilities.</p></li><li><p>The degree of the security defense mechanism is closely related to the difficulty of the attacker to carry out attacks. For example, with the same stack overflow vulnerability, it is much more difficult for an attacker to attack targets with the stack canary than targets without the canary.</p></li><li><p>The causes of vulnerabilities are various, but the means of exploiting vulnerabilities are relatively traceable. Discovering and blocking such means in time during exploitation will increase the attack cost and difficulty of attackers.</p></li></ul></blockquote><p>In addition to enabling established kernel defense mechanisms such as <strong>NX/DEP, PXN/PAN, and Canary</strong>, HarmonyOS 4.2 also <strong>employs CFI to protect indirect jumps and PAC to safeguard the return addresses of non-leaf nodes</strong>. Compared to native Android 14 and One UI 6, HarmonyOS 4.2 offers <strong>more comprehensive protection</strong>.</p><p>During testing, DARKNAVY found that <strong>HarmonyOS NEXT does not utilize PAC, CFI</strong>, and other defense mechanisms already deployed in HarmonyOS 4.2.</p><blockquote><p>PAC (Pointer Authentication Code) is a security feature introduced in the ARM architecture. It is signed by inserting an additional signature into the pointer to verify the integrity of the pointer, thus resisting JOP, ROP and other attacks.</p><p>HarmonyOS Version 4.2 uses PAC to protect the return addresses of non-leaf nodes as follows:</p><p>There is a <code>ptrauth_keys_kernel</code> structure in the kernel code, and there is a <code>ptrauth_key</code> structure in the structure. When each process is created, the kernel will execute a <code>ptrauth_keys_init_kernel</code> function. This function writes the random number 16 bytes to the <code>key_kernel</code> field of the thread struct of <code>task_struct</code> by <code>get_ramdom_bytes</code>. When the process invokes the kernel system call, Perform <code>switch_to</code> will write <code>__pki_v.lo</code> and <code>__pki_v.li</code> in <code>key_kernel</code> field in <code>task_struct</code> . The PACIASP instruction and AUTIASP instruction use the register __pki_v to calculate values written to the stack to ensure that the return address is not tampered with.</p></blockquote><p>HarmonyOS version 4.2 Separates the user PAC key from the kernel PAC key, both algorithms are the same. If an attacker can modify the user PAC key to the kernel PAC key, it may lead to control of the kernel execution flow. User-mode kernel mode algorithm isolation is recommended.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>struct</span> <span class=n>ptrauth_keys_kernel</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>ptrauth_key</span> <span class=n>apia</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>__always_inline</span> <span class=kt>void</span> <span class=nf>ptrauth_keys_init_kernel</span><span class=p>(</span><span class=k>struct</span> <span class=n>ptrauth_keys_kernel</span> <span class=o>*</span><span class=n>keys</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>system_supports_address_auth</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nf>get_random_bytes</span><span class=p>(</span><span class=o>&amp;</span><span class=n>keys</span><span class=o>-&gt;</span><span class=n>apia</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>keys</span><span class=o>-&gt;</span><span class=n>apia</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>__always_inline</span> <span class=kt>void</span> <span class=nf>ptrauth_keys_switch_kernel</span><span class=p>(</span><span class=k>struct</span> <span class=n>ptrauth_keys_kernel</span> <span class=o>*</span><span class=n>keys</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>system_supports_address_auth</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>__ptrauth_key_install_nosync</span><span class=p>(</span><span class=n>APIA</span><span class=p>,</span> <span class=n>keys</span><span class=o>-&gt;</span><span class=n>apia</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>isb</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Contemporary kernel attack methods have evolved significantly from traditional techniques. The introduction of Stack Canary, PAC, and CFI has greatly improved control flow integrity, making direct control flow hijacking attacks on the kernel increasingly rare.</p><p>In recent years, kernel privilege escalation attacks have more commonly targeted data-oriented attacks. These attacks exploit UAF (Use After Free) and OOB (Out Of Bounds) vulnerabilities to modify data pointers within the kernel, enabling arbitrary kernel address reads and writes, altering critical data structures, and escalating privileges. iOS 17 leverages hardware security features provided by its processors to implement Data PAC, and Pixel 8 uses ARM MTE in native Android, significantly enhancing defense capabilities against data-oriented attacks. However, HarmonyOS has not yet adopted these mechanisms.</p><h3 id=kernel-arbitrary-readwrite-exploit-defense-capability-index>Kernel Arbitrary Read/Write Exploit Defense Capability Index<a hidden class=anchor aria-hidden=true href=#kernel-arbitrary-readwrite-exploit-defense-capability-index>#</a></h3><blockquote><p>This index corresponds to stage 3: the ability to bypass the &ldquo;patrolling guards&rdquo; in the kernel</p></blockquote><p>The kernel code and key data protection in HarmonyOS 4.2 is more advanced than in HarmonyOS NEXT and far ahead of native Android 14. It utilizes the self-developed HKIP mechanism (similar to RKP) to protect the critical kernel data. Additionally, SPTM for iOS, implemented based on hardware features, has a smaller attack surface.</p><blockquote><p>With the continuous improvement of defense mechanisms such as PAC and CFI, the integrity of kernels control flow has been better protected, and the attack mode of hijacking kernel control flow has become rare. In recent years, a more common method is through data-oriented Attack, that is, by obtaining the arbitrary data reading and writing ability of the kernel, modifying the critical kernel data to escalate privilege. Therefore, after the attacker obtains the arbitrary read and write ability of the kernel, how to counter further attacks is the core capability of kernel security.</p><p>There are a large number of sensitive data and segments in the kernel, such as kernel code segments, which are the most priority targets for attackers. Once an attacker can tamper with the data of kernel code segments, he can obtain arbitrary execution permission of the kernel. The operating system can protect the integrity of kernel data from a higher level, which can effectively increase the difficulty of the attacker.</p></blockquote><p>RKP stands for &ldquo;Real-time Kernel Protection&rdquo; and is the name of Samsung&rsquo;s EL2 Layer defense mechanism, which is part of Samsung KNOX. The emergence of the RKP mechanism has significantly increased the difficulty for attackers, making traditional exploit methods even less effective against RKP. The following is the page table address translation diagram in RKP:</p><p><img alt=https://blog.longterm.io/samsung_rkp.html loading=lazy src=/blog/avss_report_kernel/attachments/5.png></p><p>HarmonyOS 4.2 also uses HKIP mechanism to protect the integrity of kernel code segments and read-only data segments from the EL2 level. It creates read-only memory through mmap to store important structural data and pointers in the kernel and uses HKIP to protect the integrity of the memory. The principle is similar to RKP. In both cases, an additional layer of page table mapping is made at the EL2 layer to ensure that changes to the page table at the EL1 layer can be captured and intercepted by the EL2 layer.</p><p>The HKIP mechanism in HarmonyOS version 4.2 has the same protection capability as the RKP mechanism, which protects code segments, read-only data segments, and important structures of the kernel from tampering. However, for the lack of protection of the application page table, the attacker can arbitrarily read and write the physical address that is not protected by HKIP by modifying the application&rsquo;s page table. This exploitation method has also been verified to be feasible on Pixel and Samsung Galaxy.</p><p>In HarmonyOS NEXT, HKIP provides various protection mechanisms. However, actual research has found that, apart from the code segment, read-only data segment, and kernel page table, other critical structures are not protected by HKIP.</p><p>The following is a comparison of the coverage of defense capabilities in some HKIP mechanisms and RKP mechanisms:</p><p><img loading=lazy src=/blog/avss_report_kernel/attachments/6.jpg></p><p>（o : cover x : not cover | : incomplete cover）</p><h3 id=lateral-movement-defense-capability>Lateral Movement Defense Capability<a hidden class=anchor aria-hidden=true href=#lateral-movement-defense-capability>#</a></h3><blockquote><p>The index corresponds to stage 4: the defense capability of the inter-module lateral movement</p></blockquote><p>The HarmonyOS 4.2 kernel is similar to the native Android 14 and ONE UI 6 kernel, and there is no strict permission isolation between major kernel modules, while iOS is based on a hybrid kernel architecture of Mach and BSD.</p><p>HarmonyOS NEXT uses a microkernel architecture with finer-grained kernel module isolation, which divides kernel resources into multiple types, different types are managed by corresponding modules, and modules communicate with each other through the IPC mechanism, which has a better effect on multiple modules defense against attacks.</p><blockquote><p>The kernel of the traditional operating system is responsible for the scheduling of all resources of the entire system, and once the corruption of any module of the kernel will lead to the loss of the entire operating system. With the birth of the microkernel, the permission division of the kernel module is finer-grained, so how to reduce the influence of post-exploitation diffusion has become a new measurement index of kernel security.</p><p>Network module, file management module, memory management module, driver module, etc. are the main attack targets of attackers. The fine-grained division of their permissions can effectively prevent attackers from spreading attacks from the point to the surface.</p></blockquote><p>HarmonyOS NEXT divides the permissions between modules in a fine-grained manner and communicates between modules through IPC, making it difficult for attackers to evolve the attack results of one module into the attack results of the entire system.</p><p>HarmonyOS NEXT loads the driver in user mode, making it difficult to convert an attack against the driver to an attack against the kernel EL1 layer by obtaining only EL0 permissions.</p><p><img loading=lazy src=/blog/avss_report_kernel/attachments/7.png></p><h3 id=defense-in-depth-capability>Defense-in-depth capability<a hidden class=anchor aria-hidden=true href=#defense-in-depth-capability>#</a></h3><blockquote><p>The index corresponds to stage 5: persistent resident, information theft defense capability</p></blockquote><p>Both HarmonyOS 4.2 and HarmonyOS NEXT adopt a defense-in-depth design under the kernel. They are hardened with higher-privilege hypervisors, secure monitor, TrustZone, security elements, and security chips that are isolated from the kernel. Even if an attacker can compromise the kernel, it can still protect sensitive information such as biometric information and critical keys.</p><p>HarmonyOS NEXT also improves file system protection, using different keys for different contexts to protect the confidentiality and integrity of code and data files, and key management with the Secure Enclave (TrustZone, security chip) isolated from the kernel.</p><p>Defense in depth has been widely practiced on mobile devices, and manufacturers and system developers can use hardware security primitives and chip designs provided by processors to achieve a higher level of security privileges than the kernel. Even after an attacker compromises the kernel, the system relies on a hypervisor or secure monitor that is lower than the kernel and has a smaller TCB. The TrustZone and security chip, which are isolated from the kernel, still ensure the security of users&rsquo; sensitive data.</p><h2 id=description-and-notice>Description and Notice<a hidden class=anchor aria-hidden=true href=#description-and-notice>#</a></h2><p>This report provides a preliminary adversarial analysis of the kernel defense mechanisms of each mobile operating system and does not conduct AVSS best practices, so the current version of the report does not contain evaluation scores and composite scores for all indicator subitems.</p><p>In addition, DARKNAVY based on the DAF (DarkNavy Adversarial Framework) framework, obtained the root permission of HarmonyOS NEXT system, to make the above horizontal and vertical preliminary quantitative evaluation analysis.</p><p><img loading=lazy src=/blog/avss_report_kernel/attachments/8.gif></p><p>[Next Episode Preview] How does the security capability of new operating systems perform against malicious exploit methods such as intrusive pop-up ads, background process persistence, and privacy theft? Stay tuned for the upcoming AVSS research report: &ldquo;Multi-Mobile Platform Operating System Security Adversarial Capability Preliminary Evaluation Report - Application&rdquo; as well as the release of the HarmonyOS NEXT APP Decompiler.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://www.darknavy.org/blog/exploiting_steam_usual_and_unusual_ways_in_the_cef_framework/><span class=title>« Prev</span><br><span>Exploiting Steam: Usual and Unusual Ways in the CEF Framework</span>
</a><a class=next href=https://www.darknavy.org/blog/strengthening_the_shield_mte_in_memory_allocators/><span class=title>Next »</span><br><span>Strengthening the Shield: MTE in Heap Allocators</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.darknavy.org/>DARKNAVY</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>